"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.IndexCropAction = void 0;
const sharp = require("sharp");
const __1 = require("..");
const _base_1 = require("./_base");
class IndexCropAction extends _base_1.BaseImageAction {
    constructor() {
        super(...arguments);
        this.name = 'indexcrop';
    }
    validate(params) {
        let opt = { x: 0, y: 0, i: 0 };
        if (params.length < 3) {
            throw new __1.InvalidArgument('IndexCrop param error, e.g: indexcrop,x_100,i_0');
        }
        for (const param of params) {
            if ((this.name === param) || (!param)) {
                continue;
            }
            const [k, v] = param.split('_');
            if (k === 'x') {
                opt.x = Number.parseInt(v, 10);
                if (opt.x < 0) {
                    throw new __1.InvalidArgument('Param error:  x value must be greater than 0');
                }
            }
            else if (k === 'y') {
                opt.y = Number.parseInt(v, 10);
                if (opt.y < 0) {
                    throw new __1.InvalidArgument('Param error:  y value must be greater than 0');
                }
            }
            else if (k === 'i') {
                opt.i = Number.parseInt(v, 10);
            }
            else {
                throw new __1.InvalidArgument(`Unkown param: "${k}"`);
            }
        }
        if (opt.x > 0 && opt.y > 0) {
            throw new __1.InvalidArgument('Param error:  Cannot enter x and y at the same time');
        }
        return opt;
    }
    async process(ctx, params) {
        const opt = this.validate(params);
        let x = 0;
        let y = 0;
        let w = 0;
        let h = 0;
        let needCrop = true;
        const metadata = await sharp(await ctx.image.toBuffer()).metadata();
        if (metadata.height === undefined || metadata.width === undefined) {
            throw new __1.InvalidArgument('Incorrect image format');
        }
        if (metadata.height === undefined || metadata.width === undefined) {
            throw new __1.InvalidArgument('Incorrect image format');
        }
        h = metadata.height;
        w = metadata.width;
        if (opt.x > 0) {
            if (opt.x > metadata.width) {
                needCrop = false;
                return;
            }
            const count = Math.floor(metadata.width / opt.x);
            if (opt.i + 1 > count) {
                needCrop = false;
                return;
            }
            x = opt.i * opt.x;
            w = opt.x;
        }
        else if (opt.y > 0) {
            if (opt.y > metadata.height) {
                needCrop = false;
                return;
            }
            const count = Math.floor(metadata.height / opt.y);
            if (opt.i + 1 > count) {
                needCrop = false;
                return;
            }
            y = opt.i * opt.y;
            h = opt.y;
        }
        if (needCrop) {
            ctx.image = sharp(await ctx.image.extract({
                left: x,
                top: y,
                width: w,
                height: h,
            }).toBuffer(), { animated: true });
        }
    }
}
exports.IndexCropAction = IndexCropAction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXhjcm9wLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3Byb2Nlc3Nvci9pbWFnZS9pbmRleGNyb3AudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBRS9CLDBCQUE0RDtBQUM1RCxtQ0FBMEM7QUFRMUMsTUFBYSxlQUFnQixTQUFRLHVCQUFlO0lBQXBEOztRQUNrQixTQUFJLEdBQVcsV0FBVyxDQUFDO0lBbUc3QyxDQUFDO0lBakdRLFFBQVEsQ0FBQyxNQUFnQjtRQUM5QixJQUFJLEdBQUcsR0FBa0IsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBRTlDLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDckIsTUFBTSxJQUFJLG1CQUFlLENBQUMsaURBQWlELENBQUMsQ0FBQztTQUM5RTtRQUVELEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDckMsU0FBUzthQUNWO1lBQ0QsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRTtnQkFDYixHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUMvQixJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFO29CQUNiLE1BQU0sSUFBSSxtQkFBZSxDQUFDLDhDQUE4QyxDQUFDLENBQUM7aUJBQzNFO2FBQ0Y7aUJBQU0sSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFO2dCQUNwQixHQUFHLENB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R0FBRyxDQUFDLEdBQUcsS0FBSyxFQUFFO2dCQUNyQixRQUFRLEdBQUcsS0FBSyxDQUFDO2dCQUNqQixPQUFPO2FBQ1I7WUFDRCxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBRVg7UUFFRCxJQUFJLFFBQVEsRUFBRTtZQUNaLEdBQUcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7Z0JBQ3hDLElBQUksRUFBRSxDQUFDO2dCQUNQLEdBQUcsRUFBRSxDQUFDO2dCQUNOLEtBQUssRUFBRSxDQUFDO2dCQUNSLE1BQU0sRUFBRSxDQUFDO2FBQ1YsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7U0FDcEM7SUFFSCxDQUFDO0NBQ0Y7QUFwR0QsMENBb0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgc2hhcnAgZnJvbSAnc2hhcnAnO1xuaW1wb3J0IHsgSUltYWdlQ29udGV4dCB9IGZyb20gJy4nO1xuaW1wb3J0IHsgSUFjdGlvbk9wdHMsIFJlYWRPbmx5LCBJbnZhbGlkQXJndW1lbnQgfSBmcm9tICcuLic7XG5pbXBvcnQgeyBCYXNlSW1hZ2VBY3Rpb24gfSBmcm9tICcuL19iYXNlJztcblxuZXhwb3J0IGludGVyZmFjZSBJbmRleENyb3BPcHRzIGV4dGVuZHMgSUFjdGlvbk9wdHMge1xuICB4OiBudW1iZXI7XG4gIHk6IG51bWJlcjtcbiAgaTogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgSW5kZXhDcm9wQWN0aW9uIGV4dGVuZHMgQmFzZUltYWdlQWN0aW9uIHtcbiAgcHVibGljIHJlYWRvbmx5IG5hbWU6IHN0cmluZyA9ICdpbmRleGNyb3AnO1xuXG4gIHB1YmxpYyB2YWxpZGF0ZShwYXJhbXM6IHN0cmluZ1tdKTogUmVhZE9ubHk8SW5kZXhDcm9wT3B0cz4ge1xuICAgIGxldCBvcHQ6IEluZGV4Q3JvcE9wdHMgPSB7IHg6IDAsIHk6IDAsIGk6IDAgfTtcblxuICAgIGlmIChwYXJhbXMubGVuZ3RoIDwgMykge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnSW5kZXhDcm9wIHBhcmFtIGVycm9yLCBlLmc6IGluZGV4Y3JvcCx4XzEwMCxpXzAnKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIHBhcmFtcykge1xuICAgICAgaWYgKCh0aGlzLm5hbWUgPT09IHBhcmFtKSB8fCAoIXBhcmFtKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IFtrLCB2XSA9IHBhcmFtLnNwbGl0KCdfJyk7XG4gICAgICBpZiAoayA9PT0gJ3gnKSB7XG4gICAgICAgIG9wdC54ID0gTnVtYmVyLnBhcnNlSW50KHYsIDEwKTtcbiAgICAgICAgaWYgKG9wdC54IDwgMCkge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ1BhcmFtIGVycm9yOiAgeCB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoayA9PT0gJ3knKSB7XG4gICAgICAgIG9wdC55ID0gTnVtYmVyLnBhcnNlSW50KHYsIDEwKTtcbiAgICAgICAgaWYgKG9wdC55IDwgMCkge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ1BhcmFtIGVycm9yOiAgeSB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwJyk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoayA9PT0gJ2knKSB7XG4gICAgICAgIG9wdC5pID0gTnVtYmVyLnBhcnNlSW50KHYsIDEwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoYFVua293biBwYXJhbTogXCIke2t9XCJgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9wdC54ID4gMCAmJiBvcHQueSA+IDApIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ1BhcmFtIGVycm9yOiAgQ2Fubm90IGVudGVyIHggYW5kIHkgYXQgdGhlIHNhbWUgdGltZScpO1xuICAgIH1cblxuICAgIHJldHVybiBvcHQ7XG4gIH1cblxuXG4gIHB1YmxpYyBhc3luYyBwcm9jZXNzKGN0eDogSUltYWdlQ29udGV4dCwgcGFyYW1zOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG9wdCA9IHRoaXMudmFsaWRhdGUocGFyYW1zKTtcblxuICAgIGxldCB4ID0gMDtcbiAgICBsZXQgeSA9IDA7XG4gICAgbGV0IHcgPSAwO1xuICAgIGxldCBoID0gMDtcbiAgICBsZXQgbmVlZENyb3A6IGJvb2xlYW4gPSB0cnVlO1xuXG4gICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCBzaGFycChhd2FpdCBjdHguaW1hZ2UudG9CdWZmZXIoKSkubWV0YWRhdGEoKTtcbiAgICBpZiAobWV0YWRhdGEuaGVpZ2h0ID09PSB1bmRlZmluZWQgfHwgbWV0YWRhdGEud2lkdGggPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnSW5jb3JyZWN0IGltYWdlIGZvcm1hdCcpO1xuICAgIH1cblxuXG4gICAgaWYgKG1ldGFkYXRhLmhlaWdodCA9PT0gdW5kZWZpbmVkIHx8IG1ldGFkYXRhLndpZHRoID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ0luY29ycmVjdCBpbWFnZSBmb3JtYXQnKTtcbiAgICB9XG4gICAgaCA9IG1ldGFkYXRhLmhlaWdodDtcbiAgICB3ID0gbWV0YWRhdGEud2lkdGg7XG5cbiAgICBpZiAob3B0LnggPiAwKSB7XG4gICAgICBpZiAob3B0LnggPiBtZXRhZGF0YS53aWR0aCkge1xuICAgICAgICBuZWVkQ3JvcCA9IGZhbHNlO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBjb3VudCA9IE1hdGguZmxvb3IobWV0YWRhdGEud2lkdGggLyBvcHQueCk7XG4gICAgICBpZiAob3B0LmkgKyAxID4gY291bnQpIHtcbiAgICAgICAgbmVlZENyb3AgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgeCA9IG9wdC5pICogb3B0Lng7XG4gICAgICB3ID0gb3B0Lng7XG5cbiAgICB9IGVsc2UgaWYgKG9wdC55ID4gMCkge1xuXG4gICAgICBpZiAob3B0LnkgPiBtZXRhZGF0YS5oZWlnaHQpIHtcbiAgICAgICAgbmVlZENyb3AgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjb3VudCA9IE1hdGguZmxvb3IobWV0YWRhdGEuaGVpZ2h0IC8gb3B0LnkpO1xuICAgICAgaWYgKG9wdC5pICsgMSA+IGNvdW50KSB7XG4gICAgICAgIG5lZWRDcm9wID0gZmFsc2U7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHkgPSBvcHQuaSAqIG9wdC55O1xuICAgICAgaCA9IG9wdC55O1xuXG4gICAgfVxuXG4gICAgaWYgKG5lZWRDcm9wKSB7XG4gICAgICBjdHguaW1hZ2UgPSBzaGFycChhd2FpdCBjdHguaW1hZ2UuZXh0cmFjdCh7XG4gICAgICAgIGxlZnQ6IHgsXG4gICAgICAgIHRvcDogeSxcbiAgICAgICAgd2lkdGg6IHcsXG4gICAgICAgIGhlaWdodDogaCxcbiAgICAgIH0pLnRvQnVmZmVyKCksIHsgYW5pbWF0ZWQ6IHRydWUgfSk7XG4gICAgfVxuXG4gIH1cbn0iXX0=