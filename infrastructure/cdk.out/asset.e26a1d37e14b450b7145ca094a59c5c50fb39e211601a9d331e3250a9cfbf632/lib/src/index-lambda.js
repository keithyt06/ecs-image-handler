"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const HttpErrors = require("http-errors");
const config_1 = require("./config");
const debug_1 = require("./debug");
const default_1 = require("./default");
const is = require("./is");
const processor_1 = require("./processor");
exports.handler = WrapError(async (event) => {
    var _a, _b, _c;
    console.log('event:', JSON.stringify(event));
    if (event.rawPath === '/' || event.rawPath === '/ping') {
        return resp(200, 'ok');
    }
    else if (event.rawPath === '/_debug') {
        console.log(JSON.stringify((0, debug_1.default)()));
        return resp(400, 'Please check your server logs for more details!');
    }
    const accept = (_b = (_a = event.headers.Accept) !== null && _a !== void 0 ? _a : event.headers.accept) !== null && _b !== void 0 ? _b : '';
    const autoWebp = config_1.default.autoWebp && accept.includes('image/webp');
    console.log('autoWebp:', autoWebp);
    const bs = getBufferStore(event);
    const { uri, actions } = (0, default_1.parseRequest)(event.rawPath, (_c = event.queryStringParameters) !== null && _c !== void 0 ? _c : {});
    if (actions.length > 1) {
        const processor = (0, default_1.getProcessor)(actions[0]);
        const context = await processor.newContext(uri, actions, bs);
        context.features[processor_1.Features.AutoWebp] = autoWebp;
        const { data, type } = await processor.process(context);
        return resp(200, data, type, context.headers);
    }
    else {
        const { buffer, type, headers } = await bs.get(uri, bypass);
        return resp(200, buffer, type, headers);
    }
});
function bypass() {
    // NOTE: This is intended to tell CloudFront to directly access the s3 object without through API GW.
    throw new HttpErrors[403]('Please visit s3 directly');
}
function resp(code, body, type, headers) {
    const isBase64Encoded = Buffer.isBuffer(body);
    let data = '';
    if (isBase64Encoded) {
        data = body.toString('base64');
    }
    else if (is.string(body)) {
        data = body;
        type = 'text/plain';
    }
    else {
        data = JSON.stringify(body);
        type = 'application/json';
    }
    return {
        isBase64Encoded,
        statusCode: code,
        headers: Object.assign({ 'Content-Type': type !== null && type !== void 0 ? type : 'text/plain' }, headers),
        body: data,
    };
}
function WrapError(fn) {
    return async (event) => {
        var _a, _b;
        try {
            return await fn(event);
        }
        catch (err) {
            console.error(err);
            // ENOENT support
            if (err.code === 'ENOENT') {
                err.status = 404;
                err.message = 'NotFound';
            }
            const statusCode = (_b = (_a = err.statusCode) !== null && _a !== void 0 ? _a : err.status) !== null && _b !== void 0 ? _b : 500;
            const body = {
                status: statusCode,
                name: err.name,
                message: err.message,
            };
            return resp(statusCode, body);
        }
    };
}
const DefaultBufferStore = (0, default_1.bufferStore)();
function getBufferStore(event) {
    const bucket = event.headers['x-bucket'];
    if (bucket) {
        return (0, default_1.bufferStore)(bucket);
    }
    return DefaultBufferStore;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgtbGFtYmRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2luZGV4LWxhbWJkYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSwwQ0FBMEM7QUFDMUMscUNBQThCO0FBQzlCLG1DQUE0QjtBQUM1Qix1Q0FBb0U7QUFDcEUsMkJBQTJCO0FBQzNCLDJDQUF1QztBQUcxQixRQUFBLE9BQU8sR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLEtBQTZCLEVBQW9DLEVBQUU7O0lBQ3pHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUU3QyxJQUFJLEtBQUssQ0FBQyxPQUFPLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxPQUFPLEtBQUssT0FBTyxFQUFFO1FBQ3RELE9BQU8sSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztLQUN4QjtTQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxTQUFTLEVBQUU7UUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUEsZUFBSyxHQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLEdBQUcsRUFBRSxpREFBaUQsQ0FBQyxDQUFDO0tBQ3JFO0lBRUQsTUFBTSxNQUFNLEdBQUcsTUFBQSxNQUFBLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxtQ0FBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFDO0lBQ2xFLE1BQU0sUUFBUSxHQUFHLGdCQUFNLENBQUMsUUFBUSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7SUFFbEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFbkMsTUFBTSxFQUFFLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFD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Q0FBQyxNQUFNLG1DQUFJLEdBQUcsQ0FBQztZQUN2RCxNQUFNLElBQUksR0FBRztnQkFDWCxNQUFNLEVBQUUsVUFBVTtnQkFDbEIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO2dCQUNkLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTzthQUNyQixDQUFDO1lBQ0YsT0FBTyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sa0JBQWtCLEdBQUcsSUFBQSxxQkFBVyxHQUFFLENBQUM7QUFFekMsU0FBUyxjQUFjLENBQUMsS0FBNkI7SUFDbkQsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN6QyxJQUFJLE1BQU0sRUFBRTtRQUNWLE9BQU8sSUFBQSxxQkFBVyxFQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQzVCO0lBQ0QsT0FBTyxrQkFBa0IsQ0FBQztBQUM1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgSHR0cEVycm9ycyBmcm9tICdodHRwLWVycm9ycyc7XG5pbXBvcnQgY29uZmlnIGZyb20gJy4vY29uZmlnJztcbmltcG9ydCBkZWJ1ZyBmcm9tICcuL2RlYnVnJztcbmltcG9ydCB7IGJ1ZmZlclN0b3JlLCBnZXRQcm9jZXNzb3IsIHBhcnNlUmVxdWVzdCB9IGZyb20gJy4vZGVmYXVsdCc7XG5pbXBvcnQgKiBhcyBpcyBmcm9tICcuL2lzJztcbmltcG9ydCB7IEZlYXR1cmVzIH0gZnJvbSAnLi9wcm9jZXNzb3InO1xuXG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gV3JhcEVycm9yKGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgY29uc29sZS5sb2coJ2V2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG5cbiAgaWYgKGV2ZW50LnJhd1BhdGggPT09ICcvJyB8fCBldmVudC5yYXdQYXRoID09PSAnL3BpbmcnKSB7XG4gICAgcmV0dXJuIHJlc3AoMjAwLCAnb2snKTtcbiAgfSBlbHNlIGlmIChldmVudC5yYXdQYXRoID09PSAnL19kZWJ1ZycpIHtcbiAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShkZWJ1ZygpKSk7XG4gICAgcmV0dXJuIHJlc3AoNDAwLCAnUGxlYXNlIGNoZWNrIHlvdXIgc2VydmVyIGxvZ3MgZm9yIG1vcmUgZGV0YWlscyEnKTtcbiAgfVxuXG4gIGNvbnN0IGFjY2VwdCA9IGV2ZW50LmhlYWRlcnMuQWNjZXB0ID8/IGV2ZW50LmhlYWRlcnMuYWNjZXB0ID8/ICcnO1xuICBjb25zdCBhdXRvV2VicCA9IGNvbmZpZy5hdXRvV2VicCAmJiBhY2NlcHQuaW5jbHVkZXMoJ2ltYWdlL3dlYnAnKTtcblxuICBjb25zb2xlLmxvZygnYXV0b1dlYnA6JywgYXV0b1dlYnApO1xuXG4gIGNvbnN0IGJzID0gZ2V0QnVmZmVyU3RvcmUoZXZlbnQpO1xuICBjb25zdCB7IHVyaSwgYWN0aW9ucyB9ID0gcGFyc2VSZXF1ZXN0KGV2ZW50LnJhd1BhdGgsIGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyA/PyB7fSk7XG5cbiAgaWYgKGFjdGlvbnMubGVuZ3RoID4gMSkge1xuICAgIGNvbnN0IHByb2Nlc3NvciA9IGdldFByb2Nlc3NvcihhY3Rpb25zWzBdKTtcbiAgICBjb25zdCBjb250ZXh0ID0gYXdhaXQgcHJvY2Vzc29yLm5ld0NvbnRleHQodXJpLCBhY3Rpb25zLCBicyk7XG4gICAgY29udGV4dC5mZWF0dXJlc1tGZWF0dXJlcy5BdXRvV2VicF0gPSBhdXRvV2VicDtcbiAgICBjb25zdCB7IGRhdGEsIHR5cGUgfSA9IGF3YWl0IHByb2Nlc3Nvci5wcm9jZXNzKGNvbnRleHQpO1xuXG4gICAgcmV0dXJuIHJlc3AoMjAwLCBkYXRhLCB0eXBlLCBjb250ZXh0LmhlYWRlcnMpO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHsgYnVmZmVyLCB0eXBlLCBoZWFkZXJzIH0gPSBhd2FpdCBicy5nZXQodXJpLCBieXBhc3MpO1xuXG4gICAgcmV0dXJuIHJlc3AoMjAwLCBidWZmZXIsIHR5cGUsIGhlYWRlcnMpO1xuICB9XG59KTtcblxuZnVuY3Rpb24gYnlwYXNzKCkge1xuICAvLyBOT1RFOiBUaGlzIGlzIGludGVuZGVkIHRvIHRlbGwgQ2xvdWRGcm9udCB0byBkaXJlY3RseSBhY2Nlc3MgdGhlIHMzIG9iamVjdCB3aXRob3V0IHRocm91Z2ggQVBJIEdXLlxuICB0aHJvdyBuZXcgSHR0cEVycm9yc1s0MDNdKCdQbGVhc2UgdmlzaXQgczMgZGlyZWN0bHknKTtcbn1cblxuZnVuY3Rpb24gcmVzcChjb2RlOiBudW1iZXIsIGJvZHk6IGFueSwgdHlwZT86IHN0cmluZywgaGVhZGVycz86IHsgW2tleTogc3RyaW5nXTogYW55IH0pOiBBUElHYXRld2F5UHJveHlSZXN1bHRWMiB7XG4gIGNvbnN0IGlzQmFzZTY0RW5jb2RlZCA9IEJ1ZmZlci5pc0J1ZmZlcihib2R5KTtcbiAgbGV0IGRhdGE6IHN0cmluZyA9ICcnO1xuICBpZiAoaXNCYXNlNjRFbmNvZGVkKSB7XG4gICAgZGF0YSA9IGJvZHkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICB9IGVsc2UgaWYgKGlzLnN0cmluZyhib2R5KSkge1xuICAgIGRhdGEgPSBib2R5O1xuICAgIHR5cGUgPSAndGV4dC9wbGFpbic7XG4gIH0gZWxzZSB7XG4gICAgZGF0YSA9IEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuICAgIHR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGlzQmFzZTY0RW5jb2RlZCxcbiAgICBzdGF0dXNDb2RlOiBjb2RlLFxuICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24oeyAnQ29udGVudC1UeXBlJzogdHlwZSA/PyAndGV4dC9wbGFpbicgfSwgaGVhZGVycyksXG4gICAgYm9keTogZGF0YSxcbiAgfTtcbn1cblxuaW50ZXJmYWNlIExhbWJkYUhhbmRsZXJGbiB7XG4gIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+O1xufVxuXG5cbmZ1bmN0aW9uIFdyYXBFcnJvcihmbjogTGFtYmRhSGFuZGxlckZuKTogTGFtYmRhSGFuZGxlckZuIHtcbiAgcmV0dXJuIGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IGZuKGV2ZW50KTtcbiAgICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgLy8gRU5PRU5UIHN1cHBvcnRcbiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ0VOT0VOVCcpIHtcbiAgICAgICAgZXJyLnN0YXR1cyA9IDQwNDtcbiAgICAgICAgZXJyLm1lc3NhZ2UgPSAnTm90Rm91bmQnO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IGVyci5zdGF0dXNDb2RlID8/IGVyci5zdGF0dXMgPz8gNTAwO1xuICAgICAgY29uc3QgYm9keSA9IHtcbiAgICAgICAgc3RhdHVzOiBzdGF0dXNDb2RlLFxuICAgICAgICBuYW1lOiBlcnIubmFtZSxcbiAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICB9O1xuICAgICAgcmV0dXJuIHJlc3Aoc3RhdHVzQ29kZSwgYm9keSk7XG4gICAgfVxuICB9O1xufVxuXG5jb25zdCBEZWZhdWx0QnVmZmVyU3RvcmUgPSBidWZmZXJTdG9yZSgpO1xuXG5mdW5jdGlvbiBnZXRCdWZmZXJTdG9yZShldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnRWMikge1xuICBjb25zdCBidWNrZXQgPSBldmVudC5oZWFkZXJzWyd4LWJ1Y2tldCddO1xuICBpZiAoYnVja2V0KSB7XG4gICAgcmV0dXJuIGJ1ZmZlclN0b3JlKGJ1Y2tldCk7XG4gIH1cbiAgcmV0dXJuIERlZmF1bHRCdWZmZXJTdG9yZTtcbn0iXX0=