"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const S3 = require("aws-sdk/clients/s3");
const SecretsManager = require("aws-sdk/clients/secretsmanager");
const SSM = require("aws-sdk/clients/ssm");
const HttpErrors = require("http-errors");
const Koa = require("koa"); // http://koajs.cn
const bodyParser = require("koa-bodyparser");
const koaCash = require("koa-cash");
const logger = require("koa-logger");
const Router = require("koa-router");
const lru_cache_1 = require("lru-cache");
const sharp = require("sharp");
const config_1 = require("./config");
const debug_1 = require("./debug");
const default_1 = require("./default");
const is = require("./is");
const processor_1 = require("./processor");
const MB = 1048576;
const ssm = new SSM({ region: config_1.default.region });
const smclient = new SecretsManager({ region: config_1.default.region });
// Initialize buffer stores for all configured buckets
const bufferStores = (0, default_1.getBufferStores)();
const DefaultBufferStore = (0, default_1.bufferStore)();
const app = new Koa();
const router = new Router();
const lruCache = new lru_cache_1.LRUCache({
    max: config_1.default.CACHE_MAX_ITEMS,
    maxSize: config_1.default.CACHE_MAX_SIZE_MB * MB,
    ttl: config_1.default.CACHE_TTL_SEC * 1000,
    sizeCalculation: (value) => {
        return value.body.length;
    },
});
sharp.cache({ items: 1000, files: 200, memory: 2000 });
app.use(logger());
app.use(errorHandler());
app.use(bodyParser());
app.use(koaCash({
    setCachedHeader: true,
    hash(ctx) {
        return ctx.headers['x-bucket'] + ctx.request.url;
    },
    get: (key) => {
        return Promise.resolve(lruCache.get(key));
    },
    set: (key, value) => {
        lruCache.set(key, value);
        return Promise.resolve();
    },
}));
router.post('/images', async (ctx) => {
    console.log('post request body=', ctx.request.body);
    const opt = await validatePostRequest(ctx);
    ctx.path = opt.sourceObject;
    ctx.query['x-oss-process'] = opt.params;
    ctx.headers['x-bucket'] = opt.sourceBucket;
    const { data, type } = await ossprocess(ctx);
    if (type !== 'application/json') {
        // TODO: Do we need to abstract this with IBufferStore?
        const _s3 = new S3({ region: config_1.default.region });
        await _s3.putObject({
            Bucket: opt.targetBucket,
            Key: opt.targetObject,
            ContentType: type,
            Body: data,
        }).promise();
        ctx.body = `saved result to s3://${opt.targetBucket}/${opt.targetObject}`;
    }
});
router.get(['/', '/ping'], async (ctx) => {
    ctx.body = 'ok';
    try {
        await setMaxGifLimit();
    }
    catch (err) {
        console.error(err);
    }
});
router.get(['/debug', '/_debug'], async (ctx) => {
    console.log(JSON.stringify((0, debug_1.default)(lruCache)));
    ctx.status = 400;
    ctx.body = 'Please check your server logs for more details!';
});
router.get('/(.*)', async (ctx) => {
    if (await ctx.cashed())
        return;
    const queue = sharp.counters().queue;
    if (queue > config_1.default.sharpQueueLimit) {
        ctx.body = { message: 'Too many requests, please try again later.' };
        ctx.status = 429;
        return;
    }
    // 检查Accept头是否包含image/avif
    const acceptHeader = ctx.get('Accept') || '';
    const acceptsAvif = acceptHeader.includes('image/avif');
    // 如果客户端支持AVIF并且配置启用了自动AVIF
    if (acceptsAvif && config_1.default.autoAvif) {
        ctx.features = ctx.features || {};
        ctx.features[processor_1.Features.AutoAvif] = true;
    }
    const { data, type, headers } = await ossprocess(ctx, bypass);
    ctx.body = data;
    ctx.type = type;
    ctx.set(headers);
});
app.use(router.routes());
app.use(router.allowedMethods);
app.on('error', (err) => {
    const msg = err.stack || err.toString();
    console.error(`\n${msg.replace(/^/gm, '  ')}\n`);
});
app.listen(config_1.default.port, () => {
    console.log(`Server running on port ${config_1.default.port}`);
    console.log('Config:', JSON.stringify(config_1.default));
});
function errorHandler() {
    return async (ctx, next) => {
        try {
            await next();
        }
        catch (err) {
            // ENOENT support
            if (err.code === 'ENOENT') {
                err.status = 404;
                err.message = 'NotFound';
            }
            ctx.status = err.statusCode || err.status || 500;
            ctx.body = {
                status: err.status,
                name: err.name,
                message: err.message,
            };
            ctx.app.emit('error', err, ctx);
        }
    };
}
function getBufferStore(ctx) {
    const bucket = ctx.headers['x-bucket'];
    if (bucket && typeof bucket === 'string') {
        // Check if we have a store for this bucket
        const store = bufferStores.get(bucket);
        if (store) {
            return store;
        }
        // If the bucket is not in our pre-configured list but is specified in the request,
        // create a new store for it (this allows dynamic bucket access)
        const newStore = (0, default_1.bufferStore)(bucket);
        bufferStores.set(bucket, newStore);
        return newStore;
    }
    return DefaultBufferStore;
}
async function ossprocess(ctx, beforeGetFn) {
    const { uri, actions } = (0, default_1.parseRequest)(ctx.path, ctx.query);
    // 只通过 x-bucket 头选择存储桶，不再解析路径
    const bs = getBufferStore(ctx);
    if (actions.length > 1) {
        const processor = (0, default_1.getProcessor)(actions[0]);
        const context = await processor.newContext(uri, actions, bs);
        // 如果客户端支持AVIF并且配置启用了自动AVIF
        if (ctx.features && ctx.features[processor_1.Features.AutoAvif]) {
            context.features[processor_1.Features.AutoAvif] = true;
        }
        const { data, type } = await processor.process(context);
        return { data, type, headers: context.headers };
    }
    else {
        const { buffer, type, headers } = await bs.get(uri, beforeGetFn);
        return { data: buffer, type: type, headers: headers };
    }
}
async function validatePostRequest(ctx) {
    // Fox edited in 2022/04/25: enhance the security of the post requests
    const authHeader = ctx.get('X-Client-Authorization');
    const secretHeader = await getHeaderFromSecretsManager();
    if (authHeader !== secretHeader) {
        throw new processor_1.InvalidArgument('Invalid post header.');
    }
    const body = ctx.request.body;
    if (!body) {
        throw new processor_1.InvalidArgument('Empty post body.');
    }
    const valid = body.params
        && body.sourceBucket
        && body.sourceObject
        && body.targetBucket
        && body.targetObject;
    if (!valid) {
        throw new processor_1.InvalidArgument('Invalid post body.');
    }
    return {
        params: body.params,
        sourceBucket: body.sourceBucket,
        sourceObject: body.sourceObject,
        targetBucket: body.targetBucket,
        targetObject: body.targetObject,
    };
}
function bypass() {
    // NOTE: This is intended to tell CloudFront to directly access the s3 object.
    throw new HttpErrors[403]('Please visit s3 directly');
}
async function getSecretFromSecretsManager() {
    // Load the AWS SDK
    const secretName = config_1.default.secretName;
    return smclient.getSecretValue({ SecretId: secretName }).promise();
}
async function getHeaderFromSecretsManager() {
    const secret = await getSecretFromSecretsManager();
    const secretString = secret.SecretString;
    const keypair = JSON.parse(secretString);
    return keypair['X-Client-Authorization'];
}
async function setMaxGifLimit() {
    var _a;
    if (config_1.default.configJsonParameterName) {
        const data = await ssm.getParameter({ Name: config_1.default.configJsonParameterName }).promise();
        if (data.Parameter) {
            const configJson = JSON.parse((_a = data.Parameter.Value) !== null && _a !== void 0 ? _a : '{}');
            const maxGifSizeMB = configJson.max_gif_size_mb;
            if (is.number(maxGifSizeMB)) {
                (0, default_1.setMaxGifSizeMB)(maxGifSizeMB);
            }
            const maxGifPages = configJson.max_gif_pages;
            if (is.number(maxGifPages)) {
                (0, default_1.setMaxGifPages)(maxGifPages);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5Q0FBeUM7QUFDekMsaUVBQWlFO0FBQ2pFLDJDQUEyQztBQUMzQywwQ0FBMEM7QUFDMUMsMkJBQTJCLENBQUMsa0JBQWtCO0FBQzlDLDZDQUE2QztBQUM3QyxvQ0FBb0M7QUFDcEMscUNBQXFDO0FBQ3JDLHFDQUFxQztBQUNyQyx5Q0FBcUM7QUFDckMsK0JBQStCO0FBQy9CLHFDQUE4QjtBQUM5QixtQ0FBNEI7QUFDNUIsdUNBQXNIO0FBQ3RILDJCQUEyQjtBQUMzQiwyQ0FBc0U7QUFRdEUsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDO0FBRW5CLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLGdCQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUMvQyxNQUFNLFFBQVEsR0FBRyxJQUFJLGNBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxnQkFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFFL0Qsc0RBQXNEO0FBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUEseUJBQWUsR0FBRSxDQUFDO0FBQ3ZDLE1BQU0sa0JBQWtCLEdBQUcsSUFBQSxxQkFBVyxHQUFFLENBQUM7QUFFekMsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUN0QixNQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO0FBQzVCLE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBc0I7SUFDakQsR0FBRyxFQUFFLGdCQUFNLENBQUMsZUFBZTtJQUMzQixPQUFPLEVBQUUsZ0JBQU0sQ0FBQyxpQkFBaUIsR0FBRyxFQUFFO0lBQ3RDLEdBQUcsRUFBRSxnQkFBTSxDQUFDLGFBQWEsR0FBRyxJQUFJO0lBQ2hDLGVBQWUsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1FBQ3pCLE9B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LXNkay9jbGllbnRzL3MzJztcbmltcG9ydCAqIGFzIFNlY3JldHNNYW5hZ2VyIGZyb20gJ2F3cy1zZGsvY2xpZW50cy9zZWNyZXRzbWFuYWdlcic7XG5pbXBvcnQgKiBhcyBTU00gZnJvbSAnYXdzLXNkay9jbGllbnRzL3NzbSc7XG5pbXBvcnQgKiBhcyBIdHRwRXJyb3JzIGZyb20gJ2h0dHAtZXJyb3JzJztcbmltcG9ydCAqIGFzIEtvYSBmcm9tICdrb2EnOyAvLyBodHRwOi8va29hanMuY25cbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSAna29hLWJvZHlwYXJzZXInO1xuaW1wb3J0ICogYXMga29hQ2FzaCBmcm9tICdrb2EtY2FzaCc7XG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAna29hLWxvZ2dlcic7XG5pbXBvcnQgKiBhcyBSb3V0ZXIgZnJvbSAna29hLXJvdXRlcic7XG5pbXBvcnQgeyBMUlVDYWNoZSB9IGZyb20gJ2xydS1jYWNoZSc7XG5pbXBvcnQgKiBhcyBzaGFycCBmcm9tICdzaGFycCc7XG5pbXBvcnQgY29uZmlnIGZyb20gJy4vY29uZmlnJztcbmltcG9ydCBkZWJ1ZyBmcm9tICcuL2RlYnVnJztcbmltcG9ydCB7IGJ1ZmZlclN0b3JlLCBnZXRCdWZmZXJTdG9yZXMsIGdldFByb2Nlc3NvciwgcGFyc2VSZXF1ZXN0LCBzZXRNYXhHaWZTaXplTUIsIHNldE1heEdpZlBhZ2VzIH0gZnJvbSAnLi9kZWZhdWx0JztcbmltcG9ydCAqIGFzIGlzIGZyb20gJy4vaXMnO1xuaW1wb3J0IHsgRmVhdHVyZXMsIElIdHRwSGVhZGVycywgSW52YWxpZEFyZ3VtZW50IH0gZnJvbSAnLi9wcm9jZXNzb3InO1xuaW1wb3J0IHsgSUJ1ZmZlclN0b3JlIH0gZnJvbSAnLi9zdG9yZSc7XG5cbi8vIOWumuS5ieS4gOS4quaOpeWPo+adpeaJqeWxlUtvYeS4iuS4i+aWh1xuaW50ZXJmYWNlIEV4dGVuZGVkQ29udGV4dCBleHRlbmRzIEtvYS5QYXJhbWV0ZXJpemVkQ29udGV4dCB7XG4gIGZlYXR1cmVzPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuY29uc3QgTUIgPSAxMDQ4NTc2O1xuXG5jb25zdCBzc20gPSBuZXcgU1NNKHsgcmVnaW9uOiBjb25maWcucmVnaW9uIH0pO1xuY29uc3Qgc21jbGllbnQgPSBuZXcgU2VjcmV0c01hbmFnZXIoeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSk7XG5cbi8vIEluaXRpYWxpemUgYnVmZmVyIHN0b3JlcyBmb3IgYWxsIGNvbmZpZ3VyZWQgYnVja2V0c1xuY29uc3QgYnVmZmVyU3RvcmVzID0gZ2V0QnVmZmVyU3RvcmVzKCk7XG5jb25zdCBEZWZhdWx0QnVmZmVyU3RvcmUgPSBidWZmZXJTdG9yZSgpO1xuXG5jb25zdCBhcHAgPSBuZXcgS29hKCk7XG5jb25zdCByb3V0ZXIgPSBuZXcgUm91dGVyKCk7XG5jb25zdCBscnVDYWNoZSA9IG5ldyBMUlVDYWNoZTxzdHJpbmcsIENhY2hlT2JqZWN0Pih7XG4gIG1heDogY29uZmlnLkNBQ0hFX01BWF9JVEVNUyxcbiAgbWF4U2l6ZTogY29uZmlnLkNBQ0hFX01BWF9TSVpFX01CICogTUIsXG4gIHR0bDogY29uZmlnLkNBQ0hFX1RUTF9TRUMgKiAxMDAwLFxuICBzaXplQ2FsY3VsYXRpb246ICh2YWx1ZSkgPT4ge1xuICAgIHJldHVybiB2YWx1ZS5ib2R5Lmxlbmd0aDtcbiAgfSxcbn0pO1xuXG5zaGFycC5jYWNoZSh7IGl0ZW1zOiAxMDAwLCBmaWxlczogMjAwLCBtZW1vcnk6IDIwMDAgfSk7XG5cbmFwcC51c2UobG9nZ2VyKCkpO1xuYXBwLnVzZShlcnJvckhhbmRsZXIoKSk7XG5hcHAudXNlKGJvZHlQYXJzZXIoKSk7XG5hcHAudXNlKGtvYUNhc2goe1xuICBzZXRDYWNoZWRIZWFkZXI6IHRydWUsXG4gIGhhc2goY3R4KSB7XG4gICAgcmV0dXJuIGN0eC5oZWFkZXJzWyd4LWJ1Y2tldCddICsgY3R4LnJlcXVlc3QudXJsO1xuICB9LFxuICBnZXQ6IChrZXkpID0+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGxydUNhY2hlLmdldChrZXkpKTtcbiAgfSxcbiAgc2V0OiAoa2V5LCB2YWx1ZSkgPT4ge1xuICAgIGxydUNhY2hlLnNldChrZXksIHZhbHVlIGFzIENhY2hlT2JqZWN0KTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH0sXG59KSk7XG5cbnJvdXRlci5wb3N0KCcvaW1hZ2VzJywgYXN5bmMgKGN0eCkgPT4ge1xuICBjb25zb2xlLmxvZygncG9zdCByZXF1ZXN0IGJvZHk9JywgY3R4LnJlcXVlc3QuYm9keSk7XG5cbiAgY29uc3Qgb3B0ID0gYXdhaXQgdmFsaWRhdGVQb3N0UmVxdWVzdChjdHgpO1xuICBjdHgucGF0aCA9IG9wdC5zb3VyY2VPYmplY3Q7XG4gIGN0eC5xdWVyeVsneC1vc3MtcHJvY2VzcyddID0gb3B0LnBhcmFtcztcbiAgY3R4LmhlYWRlcnNbJ3gtYnVja2V0J10gPSBvcHQuc291cmNlQnVja2V0O1xuXG4gIGNvbnN0IHsgZGF0YSwgdHlwZSB9ID0gYXdhaXQgb3NzcHJvY2VzcyhjdHgpO1xuICBpZiAodHlwZSAhPT0gJ2FwcGxpY2F0aW9uL2pzb24nKSB7XG4gICAgLy8gVE9ETzogRG8gd2UgbmVlZCB0byBhYnN0cmFjdCB0aGlzIHdpdGggSUJ1ZmZlclN0b3JlP1xuICAgIGNvbnN0IF9zMzogUzMgPSBuZXcgUzMoeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSk7XG4gICAgYXdhaXQgX3MzLnB1dE9iamVjdCh7XG4gICAgICBCdWNrZXQ6IG9wdC50YXJnZXRCdWNrZXQsXG4gICAgICBLZXk6IG9wdC50YXJnZXRPYmplY3QsXG4gICAgICBDb250ZW50VHlwZTogdHlwZSxcbiAgICAgIEJvZHk6IGRhdGEsXG4gICAgfSkucHJvbWlzZSgpO1xuXG4gICAgY3R4LmJvZHkgPSBgc2F2ZWQgcmVzdWx0IHRvIHMzOi8vJHtvcHQudGFyZ2V0QnVja2V0fS8ke29wdC50YXJnZXRPYmplY3R9YDtcbiAgfVxufSk7XG5cbnJvdXRlci5nZXQoWycvJywgJy9waW5nJ10sIGFzeW5jIChjdHgpID0+IHtcbiAgY3R4LmJvZHkgPSAnb2snO1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgc2V0TWF4R2lmTGltaXQoKTtcbiAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycik7XG4gIH1cbn0pO1xuXG5yb3V0ZXIuZ2V0KFsnL2RlYnVnJywgJy9fZGVidWcnXSwgYXN5bmMgKGN0eCkgPT4ge1xuICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShkZWJ1ZyhscnVDYWNoZSkpKTtcbiAgY3R4LnN0YXR1cyA9IDQwMDtcbiAgY3R4LmJvZHkgPSAnUGxlYXNlIGNoZWNrIHlvdXIgc2VydmVyIGxvZ3MgZm9yIG1vcmUgZGV0YWlscyEnO1xufSk7XG5cbnJvdXRlci5nZXQoJy8oLiopJywgYXN5bmMgKGN0eDogRXh0ZW5kZWRDb250ZXh0KSA9PiB7XG4gIGlmIChhd2FpdCBjdHguY2FzaGVkKCkpIHJldHVybjtcblxuICBjb25zdCBxdWV1ZSA9IHNoYXJwLmNvdW50ZXJzKCkucXVldWU7XG4gIGlmIChxdWV1ZSA+IGNvbmZpZy5zaGFycFF1ZXVlTGltaXQpIHtcbiAgICBjdHguYm9keSA9IHsgbWVzc2FnZTogJ1RvbyBtYW55IHJlcXVlc3RzLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicgfTtcbiAgICBjdHguc3RhdHVzID0gNDI5O1xuICAgIHJldHVybjtcbiAgfVxuICBcbiAgLy8g5qOA5p+lQWNjZXB05aS05piv5ZCm5YyF5ZCraW1hZ2UvYXZpZlxuICBjb25zdCBhY2NlcHRIZWFkZXIgPSBjdHguZ2V0KCdBY2NlcHQnKSB8fCAnJztcbiAgY29uc3QgYWNjZXB0c0F2aWYgPSBhY2NlcHRIZWFkZXIuaW5jbHVkZXMoJ2ltYWdlL2F2aWYnKTtcbiAgXG4gIC8vIOWmguaenOWuouaIt+err+aUr+aMgUFWSUblubbkuJTphY3nva7lkK/nlKjkuoboh6rliqhBVklGXG4gIGlmIChhY2NlcHRzQXZpZiAmJiBjb25maWcuYXV0b0F2aWYpIHtcbiAgICBjdHguZmVhdHVyZXMgPSBjdHguZmVhdHVyZXMgfHwge307XG4gICAgY3R4LmZlYXR1cmVzW0ZlYXR1cmVzLkF1dG9BdmlmXSA9IHRydWU7XG4gIH1cbiAgXG4gIGNvbnN0IHsgZGF0YSwgdHlwZSwgaGVhZGVycyB9ID0gYXdhaXQgb3NzcHJvY2VzcyhjdHgsIGJ5cGFzcyk7XG4gIGN0eC5ib2R5ID0gZGF0YTtcbiAgY3R4LnR5cGUgPSB0eXBlO1xuICBjdHguc2V0KGhlYWRlcnMpO1xufSk7XG5cbmFwcC51c2Uocm91dGVyLnJvdXRlcygpKTtcbmFwcC51c2Uocm91dGVyLmFsbG93ZWRNZXRob2RzKTtcblxuYXBwLm9uKCdlcnJvcicsIChlcnI6IEVycm9yKSA9PiB7XG4gIGNvbnN0IG1zZyA9IGVyci5zdGFjayB8fCBlcnIudG9TdHJpbmcoKTtcbiAgY29uc29sZS5lcnJvcihgXFxuJHttc2cucmVwbGFjZSgvXi9nbSwgJyAgJyl9XFxuYCk7XG59KTtcblxuYXBwLmxpc3Rlbihjb25maWcucG9ydCwgKCkgPT4ge1xuICBjb25zb2xlLmxvZyhgU2VydmVyIHJ1bm5pbmcgb24gcG9ydCAke2NvbmZpZy5wb3J0fWApO1xuICBjb25zb2xlLmxvZygnQ29uZmlnOicsIEpTT04uc3RyaW5naWZ5KGNvbmZpZykpO1xufSk7XG5cbmZ1bmN0aW9uIGVycm9ySGFuZGxlcigpOiBLb2EuTWlkZGxld2FyZTxLb2EuRGVmYXVsdFN0YXRlLCBLb2EuRGVmYXVsdENvbnRleHQsIGFueT4ge1xuICByZXR1cm4gYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBuZXh0KCk7XG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIC8vIEVOT0VOVCBzdXBwb3J0XG4gICAgICBpZiAoZXJyLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAgIGVyci5zdGF0dXMgPSA0MDQ7XG4gICAgICAgIGVyci5tZXNzYWdlID0gJ05vdEZvdW5kJztcbiAgICAgIH1cbiAgICAgIGN0eC5zdGF0dXMgPSBlcnIuc3RhdHVzQ29kZSB8fCBlcnIuc3RhdHVzIHx8IDUwMDtcbiAgICAgIGN0eC5ib2R5ID0ge1xuICAgICAgICBzdGF0dXM6IGVyci5zdGF0dXMsXG4gICAgICAgIG5hbWU6IGVyci5uYW1lLFxuICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgIH07XG5cbiAgICAgIGN0eC5hcHAuZW1pdCgnZXJyb3InLCBlcnIsIGN0eCk7XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRCdWZmZXJTdG9yZShjdHg6IEV4dGVuZGVkQ29udGV4dCk6IElCdWZmZXJTdG9yZSB7XG4gIGNvbnN0IGJ1Y2tldCA9IGN0eC5oZWFkZXJzWyd4LWJ1Y2tldCddO1xuICBpZiAoYnVja2V0ICYmIHR5cGVvZiBidWNrZXQgPT09ICdzdHJpbmcnKSB7XG4gICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIHN0b3JlIGZvciB0aGlzIGJ1Y2tldFxuICAgIGNvbnN0IHN0b3JlID0gYnVmZmVyU3RvcmVzLmdldChidWNrZXQpO1xuICAgIGlmIChzdG9yZSkge1xuICAgICAgcmV0dXJuIHN0b3JlO1xuICAgIH1cbiAgICBcbiAgICAvLyBJZiB0aGUgYnVja2V0IGlzIG5vdCBpbiBvdXIgcHJlLWNvbmZpZ3VyZWQgbGlzdCBidXQgaXMgc3BlY2lmaWVkIGluIHRoZSByZXF1ZXN0LFxuICAgIC8vIGNyZWF0ZSBhIG5ldyBzdG9yZSBmb3IgaXQgKHRoaXMgYWxsb3dzIGR5bmFtaWMgYnVja2V0IGFjY2VzcylcbiAgICBjb25zdCBuZXdTdG9yZSA9IGJ1ZmZlclN0b3JlKGJ1Y2tldCk7XG4gICAgYnVmZmVyU3RvcmVzLnNldChidWNrZXQsIG5ld1N0b3JlKTtcbiAgICByZXR1cm4gbmV3U3RvcmU7XG4gIH1cbiAgcmV0dXJuIERlZmF1bHRCdWZmZXJTdG9yZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gb3NzcHJvY2VzcyhjdHg6IEV4dGVuZGVkQ29udGV4dCwgYmVmb3JlR2V0Rm4/OiAoKSA9PiB2b2lkKTpcblByb21pc2U8eyBkYXRhOiBhbnk7IHR5cGU6IHN0cmluZzsgaGVhZGVyczogSUh0dHBIZWFkZXJzIH0+IHtcbiAgY29uc3QgeyB1cmksIGFjdGlvbnMgfSA9IHBhcnNlUmVxdWVzdChjdHgucGF0aCwgY3R4LnF1ZXJ5KTtcbiAgXG4gIC8vIOWPqumAmui/hyB4LWJ1Y2tldCDlpLTpgInmi6nlrZjlgqjmobbvvIzkuI3lho3op6PmnpDot6/lvoRcbiAgY29uc3QgYnMgPSBnZXRCdWZmZXJTdG9yZShjdHgpO1xuICBpZiAoYWN0aW9ucy5sZW5ndGggPiAxKSB7XG4gICAgY29uc3QgcHJvY2Vzc29yID0gZ2V0UHJvY2Vzc29yKGFjdGlvbnNbMF0pO1xuICAgIGNvbnN0IGNvbnRleHQgPSBhd2FpdCBwcm9jZXNzb3IubmV3Q29udGV4dCh1cmksIGFjdGlvbnMsIGJzKTtcbiAgICBcbiAgICAvLyDlpoLmnpzlrqLmiLfnq6/mlK/mjIFBVklG5bm25LiU6YWN572u5ZCv55So5LqG6Ieq5YqoQVZJRlxuICAgIGlmIChjdHguZmVhdHVyZXMgJiYgY3R4LmZlYXR1cmVzW0ZlYXR1cmVzLkF1dG9BdmlmXSkge1xuICAgICAgY29udGV4dC5mZWF0dXJlc1tGZWF0dXJlcy5BdXRvQXZpZl0gPSB0cnVlO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCB7IGRhdGEsIHR5cGUgfSA9IGF3YWl0IHByb2Nlc3Nvci5wcm9jZXNzKGNvbnRleHQpO1xuICAgIHJldHVybiB7IGRhdGEsIHR5cGUsIGhlYWRlcnM6IGNvbnRleHQuaGVhZGVycyB9O1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHsgYnVmZmVyLCB0eXBlLCBoZWFkZXJzIH0gPSBhd2FpdCBicy5nZXQodXJpLCBiZWZvcmVHZXRGbik7XG4gICAgcmV0dXJuIHsgZGF0YTogYnVmZmVyLCB0eXBlOiB0eXBlLCBoZWFkZXJzOiBoZWFkZXJzIH07XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdmFsaWRhdGVQb3N0UmVxdWVzdChjdHg6IEtvYS5QYXJhbWV0ZXJpemVkQ29udGV4dCkge1xuICAvLyBGb3ggZWRpdGVkIGluIDIwMjIvMDQvMjU6IGVuaGFuY2UgdGhlIHNlY3VyaXR5IG9mIHRoZSBwb3N0IHJlcXVlc3RzXG4gIGNvbnN0IGF1dGhIZWFkZXIgPSBjdHguZ2V0KCdYLUNsaWVudC1BdXRob3JpemF0aW9uJyk7XG4gIGNvbnN0IHNlY3JldEhlYWRlciA9IGF3YWl0IGdldEhlYWRlckZyb21TZWNyZXRzTWFuYWdlcigpO1xuXG4gIGlmIChhdXRoSGVhZGVyICE9PSBzZWNyZXRIZWFkZXIpIHtcbiAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KCdJbnZhbGlkIHBvc3QgaGVhZGVyLicpO1xuICB9XG5cbiAgY29uc3QgYm9keSA9IGN0eC5yZXF1ZXN0LmJvZHk7XG4gIGlmICghYm9keSkge1xuICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ0VtcHR5IHBvc3QgYm9keS4nKTtcbiAgfVxuICBjb25zdCB2YWxpZCA9IGJvZHkucGFyYW1zXG4gICAgJiYgYm9keS5zb3VyY2VCdWNrZXRcbiAgICAmJiBib2R5LnNvdXJjZU9iamVjdFxuICAgICYmIGJvZHkudGFyZ2V0QnVja2V0XG4gICAgJiYgYm9keS50YXJnZXRPYmplY3Q7XG4gIGlmICghdmFsaWQpIHtcbiAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KCdJbnZhbGlkIHBvc3QgYm9keS4nKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHBhcmFtczogYm9keS5wYXJhbXMsXG4gICAgc291cmNlQnVja2V0OiBib2R5LnNvdXJjZUJ1Y2tldCxcbiAgICBzb3VyY2VPYmplY3Q6IGJvZHkuc291cmNlT2JqZWN0LFxuICAgIHRhcmdldEJ1Y2tldDogYm9keS50YXJnZXRCdWNrZXQsXG4gICAgdGFyZ2V0T2JqZWN0OiBib2R5LnRhcmdldE9iamVjdCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gYnlwYXNzKCkge1xuICAvLyBOT1RFOiBUaGlzIGlzIGludGVuZGVkIHRvIHRlbGwgQ2xvdWRGcm9udCB0byBkaXJlY3RseSBhY2Nlc3MgdGhlIHMzIG9iamVjdC5cbiAgdGhyb3cgbmV3IEh0dHBFcnJvcnNbNDAzXSgnUGxlYXNlIHZpc2l0IHMzIGRpcmVjdGx5Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNlY3JldEZyb21TZWNyZXRzTWFuYWdlcigpIHtcbiAgLy8gTG9hZCB0aGUgQVdTIFNES1xuICBjb25zdCBzZWNyZXROYW1lID0gY29uZmlnLnNlY3JldE5hbWU7XG4gIHJldHVybiBzbWNsaWVudC5nZXRTZWNyZXRWYWx1ZSh7IFNlY3JldElkOiBzZWNyZXROYW1lIH0pLnByb21pc2UoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0SGVhZGVyRnJvbVNlY3JldHNNYW5hZ2VyKCkge1xuICBjb25zdCBzZWNyZXQgPSBhd2FpdCBnZXRTZWNyZXRGcm9tU2VjcmV0c01hbmFnZXIoKTtcbiAgY29uc3Qgc2VjcmV0U3RyaW5nID0gc2VjcmV0LlNlY3JldFN0cmluZyE7XG4gIGNvbnN0IGtleXBhaXIgPSBKU09OLnBhcnNlKHNlY3JldFN0cmluZyk7XG4gIHJldHVybiBrZXlwYWlyWydYLUNsaWVudC1BdXRob3JpemF0aW9uJ107XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldE1heEdpZkxpbWl0KCkge1xuICBpZiAoY29uZmlnLmNvbmZpZ0pzb25QYXJhbWV0ZXJOYW1lKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHNzbS5nZXRQYXJhbWV0ZXIoeyBOYW1lOiBjb25maWcuY29uZmlnSnNvblBhcmFtZXRlck5hbWUgfSkucHJvbWlzZSgpO1xuICAgIGlmIChkYXRhLlBhcmFtZXRlcikge1xuICAgICAgY29uc3QgY29uZmlnSnNvbiA9IEpTT04ucGFyc2UoZGF0YS5QYXJhbWV0ZXIuVmFsdWUgPz8gJ3t9Jyk7XG4gICAgICBjb25zdCBtYXhHaWZTaXplTUIgPSBjb25maWdKc29uLm1heF9naWZfc2l6ZV9tYjtcbiAgICAgIGlmIChpcy5udW1iZXIobWF4R2lmU2l6ZU1CKSkge1xuICAgICAgICBzZXRNYXhHaWZTaXplTUIobWF4R2lmU2l6ZU1CKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1heEdpZlBhZ2VzID0gY29uZmlnSnNvbi5tYXhfZ2lmX3BhZ2VzO1xuICAgICAgaWYgKGlzLm51bWJlcihtYXhHaWZQYWdlcykpIHtcbiAgICAgICAgc2V0TWF4R2lmUGFnZXMobWF4R2lmUGFnZXMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufSJdfQ==