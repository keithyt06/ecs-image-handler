"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ResizeAction = void 0;
const sharp = require("sharp");
const __1 = require("..");
const is = require("../../is");
const _base_1 = require("./_base");
class ResizeAction extends _base_1.BaseImageAction {
    constructor() {
        super(...arguments);
        this.name = 'resize';
    }
    validate(params) {
        const opt = {
            m: "lfit" /* Mode.LFIT */,
            limit: true,
            color: '#FFFFFF',
        };
        for (const param of params) {
            if ((this.name === param) || (!param)) {
                continue;
            }
            const [k, v] = param.split('_');
            if (k === 'w') {
                opt.w = Number.parseInt(v, 10);
            }
            else if (k === 'h') {
                opt.h = Number.parseInt(v, 10);
            }
            else if (k === 'l') {
                opt.l = Number.parseInt(v, 10);
            }
            else if (k === 's') {
                opt.s = Number.parseInt(v, 10);
            }
            else if (k === 'm') {
                if (v && ((v === "lfit" /* Mode.LFIT */) || (v === "mfit" /* Mode.MFIT */) || (v === "fill" /* Mode.FILL */) || (v === "pad" /* Mode.PAD */) || (v === "fixed" /* Mode.FIXED */))) {
                    opt.m = v;
                }
                else {
                    throw new __1.InvalidArgument(`Unkown m: "${v}"`);
                }
            }
            else if (k === 'limit') {
                if (v && (v === '0' || v === '1')) {
                    opt.limit = (v === '1');
                }
                else {
                    throw new __1.InvalidArgument(`Unkown limit: "${v}"`);
                }
            }
            else if (k === 'color') {
                const color = '#' + v;
                if (is.hexColor(color)) {
                    opt.color = color;
                }
                else {
                    throw new __1.InvalidArgument(`Unkown color: "${v}"`);
                }
            }
            else if (k === 'p') {
                const p = Number.parseInt(v, 10);
                if (is.inRange(p, 1, 1000)) {
                    opt.p = p;
                }
                else {
                    throw new __1.InvalidArgument(`Unkown p: "${v}"`);
                }
            }
            else {
                throw new __1.InvalidArgument(`Unkown param: "${k}"`);
            }
        }
        return opt;
    }
    beforeProcess(ctx, params, index) {
        const metadata = ctx.metadata;
        if ('gif' === metadata.format) {
            const opt = buildSharpOpt(ctx, this.validate(params));
            const isEnlargingWidth = (opt.width && metadata.width && opt.width > metadata.width);
            const isEnlargingHeight = (opt.height && metadata.pageHeight && (opt.height > metadata.pageHeight));
            if (isEnlargingWidth || isEnlargingHeight) {
                ctx.mask.disable(index);
            }
        }
    }
    async process(ctx, params) {
        const opt = buildSharpOpt(ctx, this.validate(params));
        ctx.image.resize(null, null, opt);
    }
}
exports.ResizeAction = ResizeAction;
function buildSharpOpt(ctx, o) {
    const opt = {
        width: o.w,
        height: o.h,
        withoutEnlargement: o.limit,
        background: o.color,
    };
    // Mode
    if (o.m === "lfit" /* Mode.LFIT */) {
        opt.fit = sharp.fit.inside;
    }
    else if (o.m === "mfit" /* Mode.MFIT */) {
        opt.fit = sharp.fit.outside;
    }
    else if (o.m === "fill" /* Mode.FILL */) {
        opt.fit = sharp.fit.cover;
    }
    else if (o.m === "pad" /* Mode.PAD */) {
        opt.fit = sharp.fit.contain;
    }
    else if (o.m === "fixed" /* Mode.FIXED */) {
        opt.fit = sharp.fit.fill;
    }
    const metadata = ctx.metadata;
    if (!(metadata.width && metadata.height)) {
        throw new __1.InvalidArgument('Can\'t read image\'s width and height');
    }
    if (o.p && (!o.w) && (!o.h)) {
        opt.withoutEnlargement = false;
        opt.width = Math.round(metadata.width * o.p * 0.01);
    }
    else {
        if (o.l) {
            if (metadata.width > metadata.height) {
                opt.width = o.l;
            }
            else {
                opt.height = o.l;
            }
        }
        if (o.s) {
            if (metadata.height < metadata.width) {
                opt.height = o.s;
            }
            else {
                opt.width = o.s;
            }
        }
    }
    return opt;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzaXplLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3Byb2Nlc3Nvci9pbWFnZS9yZXNpemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBRS9CLDBCQUE0RDtBQUM1RCwrQkFBK0I7QUFDL0IsbUNBQTBDO0FBcUIxQyxNQUFhLFlBQWEsU0FBUSx1QkFBZTtJQUFqRDs7UUFDa0IsU0FBSSxHQUFXLFFBQVEsQ0FBQztJQXNFMUMsQ0FBQztJQXBFUSxRQUFRLENBQUMsTUFBZ0I7UUFDOUIsTUFBTSxHQUFHLEdBQWU7WUFDdEIsQ0FBQyx3QkFBVztZQUNaLEtBQUssRUFBRSxJQUFJO1lBQ1gsS0FBSyxFQUFFLFNBQVM7U0FDakIsQ0FBQztRQUNGLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDckMsU0FBUzthQUNWO1lBQ0QsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRTtnQkFDYixHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQ2hDO2lCQUFNLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRTtnQkFDcEIsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQzthQUNoQztpQkFBTSxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUU7Z0JBQ3BCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDaEM7aUJBQU0s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cm9tICdzaGFycCc7XG5pbXBvcnQgeyBJSW1hZ2VDb250ZXh0IH0gZnJvbSAnLic7XG5pbXBvcnQgeyBJQWN0aW9uT3B0cywgSW52YWxpZEFyZ3VtZW50LCBSZWFkT25seSB9IGZyb20gJy4uJztcbmltcG9ydCAqIGFzIGlzIGZyb20gJy4uLy4uL2lzJztcbmltcG9ydCB7IEJhc2VJbWFnZUFjdGlvbiB9IGZyb20gJy4vX2Jhc2UnO1xuXG5leHBvcnQgY29uc3QgZW51bSBNb2RlIHtcbiAgTEZJVCA9ICdsZml0JyxcbiAgTUZJVCA9ICdtZml0JyxcbiAgRklMTCA9ICdmaWxsJyxcbiAgUEFEID0gJ3BhZCcsXG4gIEZJWEVEID0gJ2ZpeGVkJ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlc2l6ZU9wdHMgZXh0ZW5kcyBJQWN0aW9uT3B0cyB7XG4gIG0/OiBNb2RlO1xuICB3PzogbnVtYmVyO1xuICBoPzogbnVtYmVyO1xuICBsPzogbnVtYmVyO1xuICBzPzogbnVtYmVyO1xuICBsaW1pdD86IGJvb2xlYW47XG4gIGNvbG9yPzogc3RyaW5nO1xuICBwPzogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgUmVzaXplQWN0aW9uIGV4dGVuZHMgQmFzZUltYWdlQWN0aW9uIHtcbiAgcHVibGljIHJlYWRvbmx5IG5hbWU6IHN0cmluZyA9ICdyZXNpemUnO1xuXG4gIHB1YmxpYyB2YWxpZGF0ZShwYXJhbXM6IHN0cmluZ1tdKTogUmVhZE9ubHk8UmVzaXplT3B0cz4ge1xuICAgIGNvbnN0IG9wdDogUmVzaXplT3B0cyA9IHtcbiAgICAgIG06IE1vZGUuTEZJVCxcbiAgICAgIGxpbWl0OiB0cnVlLFxuICAgICAgY29sb3I6ICcjRkZGRkZGJyxcbiAgICB9O1xuICAgIGZvciAoY29uc3QgcGFyYW0gb2YgcGFyYW1zKSB7XG4gICAgICBpZiAoKHRoaXMubmFtZSA9PT0gcGFyYW0pIHx8ICghcGFyYW0pKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgW2ssIHZdID0gcGFyYW0uc3BsaXQoJ18nKTtcbiAgICAgIGlmIChrID09PSAndycpIHtcbiAgICAgICAgb3B0LncgPSBOdW1iZXIucGFyc2VJbnQodiwgMTApO1xuICAgICAgfSBlbHNlIGlmIChrID09PSAnaCcpIHtcbiAgICAgICAgb3B0LmggPSBOdW1iZXIucGFyc2VJbnQodiwgMTApO1xuICAgICAgfSBlbHNlIGlmIChrID09PSAnbCcpIHtcbiAgICAgICAgb3B0LmwgPSBOdW1iZXIucGFyc2VJbnQodiwgMTApO1xuICAgICAgfSBlbHNlIGlmIChrID09PSAncycpIHtcbiAgICAgICAgb3B0LnMgPSBOdW1iZXIucGFyc2VJbnQodiwgMTApO1xuICAgICAgfSBlbHNlIGlmIChrID09PSAnbScpIHtcbiAgICAgICAgaWYgKHYgJiYgKCh2ID09PSBNb2RlLkxGSVQpIHx8ICh2ID09PSBNb2RlLk1GSVQpIHx8ICh2ID09PSBNb2RlLkZJTEwpIHx8ICh2ID09PSBNb2RlLlBBRCkgfHwgKHYgPT09IE1vZGUuRklYRUQpKSkge1xuICAgICAgICAgIG9wdC5tID0gdjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KGBVbmtvd24gbTogXCIke3Z9XCJgKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChrID09PSAnbGltaXQnKSB7XG4gICAgICAgIGlmICh2ICYmICh2ID09PSAnMCcgfHwgdiA9PT0gJzEnKSkge1xuICAgICAgICAgIG9wdC5saW1pdCA9ICh2ID09PSAnMScpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoYFVua293biBsaW1pdDogXCIke3Z9XCJgKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChrID09PSAnY29sb3InKSB7XG4gICAgICAgIGNvbnN0IGNvbG9yID0gJyMnICsgdjtcbiAgICAgICAgaWYgKGlzLmhleENvbG9yKGNvbG9yKSkge1xuICAgICAgICAgIG9wdC5jb2xvciA9IGNvbG9yO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoYFVua293biBjb2xvcjogXCIke3Z9XCJgKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChrID09PSAncCcpIHtcbiAgICAgICAgY29uc3QgcCA9IE51bWJlci5wYXJzZUludCh2LCAxMCk7XG4gICAgICAgIGlmIChpcy5pblJhbmdlKHAsIDEsIDEwMDApKSB7XG4gICAgICAgICAgb3B0LnAgPSBwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoYFVua293biBwOiBcIiR7dn1cImApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KGBVbmtvd24gcGFyYW06IFwiJHtrfVwiYCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvcHQ7XG4gIH1cblxuICBwdWJsaWMgYmVmb3JlUHJvY2VzcyhjdHg6IElJbWFnZUNvbnRleHQsIHBhcmFtczogc3RyaW5nW10sIGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBtZXRhZGF0YSA9IGN0eC5tZXRhZGF0YTtcbiAgICBpZiAoJ2dpZicgPT09IG1ldGFkYXRhLmZvcm1hdCkge1xuICAgICAgY29uc3Qgb3B0ID0gYnVpbGRTaGFycE9wdChjdHgsIHRoaXMudmFsaWRhdGUocGFyYW1zKSk7XG4gICAgICBjb25zdCBpc0VubGFyZ2luZ1dpZHRoID0gKG9wdC53aWR0aCAmJiBtZXRhZGF0YS53aWR0aCAmJiBvcHQud2lkdGggPiBtZXRhZGF0YS53aWR0aCk7XG4gICAgICBjb25zdCBpc0VubGFyZ2luZ0hlaWdodCA9IChvcHQuaGVpZ2h0ICYmIG1ldGFkYXRhLnBhZ2VIZWlnaHQgJiYgKG9wdC5oZWlnaHQgPiBtZXRhZGF0YS5wYWdlSGVpZ2h0KSk7XG4gICAgICBpZiAoaXNFbmxhcmdpbmdXaWR0aCB8fCBpc0VubGFyZ2luZ0hlaWdodCkge1xuICAgICAgICBjdHgubWFzay5kaXNhYmxlKGluZGV4KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcHJvY2VzcyhjdHg6IElJbWFnZUNvbnRleHQsIHBhcmFtczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBvcHQgPSBidWlsZFNoYXJwT3B0KGN0eCwgdGhpcy52YWxpZGF0ZShwYXJhbXMpKTtcbiAgICBjdHguaW1hZ2UucmVzaXplKG51bGwsIG51bGwsIG9wdCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYnVpbGRTaGFycE9wdChjdHg6IElJbWFnZUNvbnRleHQsIG86IFJlc2l6ZU9wdHMpOiBzaGFycC5SZXNpemVPcHRpb25zIHtcbiAgY29uc3Qgb3B0OiBzaGFycC5SZXNpemVPcHRpb25zID0ge1xuICAgIHdpZHRoOiBvLncsXG4gICAgaGVpZ2h0OiBvLmgsXG4gICAgd2l0aG91dEVubGFyZ2VtZW50OiBvLmxpbWl0LFxuICAgIGJhY2tncm91bmQ6IG8uY29sb3IsXG4gIH07XG4gIC8vIE1vZGVcbiAgaWYgKG8ubSA9PT0gTW9kZS5MRklUKSB7XG4gICAgb3B0LmZpdCA9IHNoYXJwLmZpdC5pbnNpZGU7XG4gIH0gZWxzZSBpZiAoby5tID09PSBNb2RlLk1GSVQpIHtcbiAgICBvcHQuZml0ID0gc2hhcnAuZml0Lm91dHNpZGU7XG4gIH0gZWxzZSBpZiAoby5tID09PSBNb2RlLkZJTEwpIHtcbiAgICBvcHQuZml0ID0gc2hhcnAuZml0LmNvdmVyO1xuICB9IGVsc2UgaWYgKG8ubSA9PT0gTW9kZS5QQUQpIHtcbiAgICBvcHQuZml0ID0gc2hhcnAuZml0LmNvbnRhaW47XG4gIH0gZWxzZSBpZiAoby5tID09PSBNb2RlLkZJWEVEKSB7XG4gICAgb3B0LmZpdCA9IHNoYXJwLmZpdC5maWxsO1xuICB9XG4gIGNvbnN0IG1ldGFkYXRhID0gY3R4Lm1ldGFkYXRhO1xuICBpZiAoIShtZXRhZGF0YS53aWR0aCAmJiBtZXRhZGF0YS5oZWlnaHQpKSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnQ2FuXFwndCByZWFkIGltYWdlXFwncyB3aWR0aCBhbmQgaGVpZ2h0Jyk7XG4gIH1cblxuICBpZiAoby5wICYmICghby53KSAmJiAoIW8uaCkpIHtcbiAgICBvcHQud2l0aG91dEVubGFyZ2VtZW50ID0gZmFsc2U7XG4gICAgb3B0LndpZHRoID0gTWF0aC5yb3VuZChtZXRhZGF0YS53aWR0aCAqIG8ucCAqIDAuMDEpO1xuICB9IGVsc2Uge1xuICAgIGlmIChvLmwpIHtcbiAgICAgIGlmIChtZXRhZGF0YS53aWR0aCA+IG1ldGFkYXRhLmhlaWdodCkge1xuICAgICAgICBvcHQud2lkdGggPSBvLmw7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvcHQuaGVpZ2h0ID0gby5sO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoby5zKSB7XG4gICAgICBpZiAobWV0YWRhdGEuaGVpZ2h0IDwgbWV0YWRhdGEud2lkdGgpIHtcbiAgICAgICAgb3B0LmhlaWdodCA9IG8ucztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdC53aWR0aCA9IG8ucztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG9wdDtcbn0iXX0=