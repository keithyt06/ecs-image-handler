"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CompressAction = void 0;
const child_process = require("child_process");
const __1 = require("..");
class CompressAction {
    constructor() {
        this.name = 'compress';
    }
    validate(params) {
        let opt = {
            q: 23,
            r: 30,
            s: '720p',
            br: 1500,
            fmt: 'mp4',
            preset: 'medium' // 默认中等压缩速度
        };
        for (const param of params) {
            if ((this.name === param) || (!param)) {
                continue;
            }
            const [k, v] = param.split('_');
            if (!v)
                continue;
            switch (k) {
                case 'q':
                    const quality = Number(v);
                    if (isNaN(quality) || quality < 1 || quality > 51) {
                        throw new __1.InvalidArgument(`Invalid quality value: ${v}, must be between 1-51`);
                    }
                    opt.q = quality;
                    break;
                case 'r':
                    const framerate = Number(v);
                    if (isNaN(framerate) || framerate < 1 || framerate > 60) {
                        throw new __1.InvalidArgument(`Invalid framerate value: ${v}, must be between 1-60`);
                    }
                    opt.r = framerate;
                    break;
                case 's':
                    // 支持常见分辨率或自定义尺寸
                    if (!['360p', '480p', '720p', '1080p'].includes(v) &&
                        !v.match(/^\d+x\d+$/)) {
                        throw new __1.InvalidArgument(`Invalid size value: ${v}`);
                    }
                    opt.s = v;
                    break;
                case 'br':
                    const bitrate = Number(v);
                    if (isNaN(bitrate) || bitrate < 100) {
                        throw new __1.InvalidArgument(`Invalid bitrate value: ${v}`);
                    }
                    opt.br = bitrate;
                    break;
                case 'fmt':
                    if (!['mp4', 'webm', 'hls'].includes(v)) {
                        throw new __1.InvalidArgument(`Unsupported format: ${v}, must be mp4, webm or hls`);
                    }
                    opt.fmt = v;
                    break;
                case 'preset':
                    if (!['ultrafast', 'superfast', 'veryfast', 'faster', 'fast', 'medium', 'slow', 'slower', 'veryslow'].includes(v)) {
                        throw new __1.InvalidArgument(`Invalid preset: ${v}`);
                    }
                    opt.preset = v;
                    break;
                default:
                    throw new __1.InvalidArgument(`Unknown parameter: ${k}`);
            }
        }
        return opt;
    }
    async process(ctx, params) {
        const opt = this.validate(params);
        const url = await ctx.bufferStore.url(ctx.uri);
        // 构建ffmpeg命令参数
        const ffmpegArgs = this.buildFFmpegArgs(url, opt);
        try {
            console.log(`开始压缩视频: ${ctx.uri} - ${JSON.stringify(opt)}`);
            // 执行ffmpeg处理
            const data = await this.executeFFmpeg(ffmpegArgs);
            console.log(`视频压缩完成: ${ctx.uri}, 输出大小: ${data.length / (1024 * 1024)}MB`);
            // 设置响应数据
            ctx.result = {
                data,
                type: this.getContentType(opt.fmt)
            };
        }
        catch (error) {
            console.error(`视频压缩失败: ${error.message || '未知错误'}`);
            throw error;
        }
    }
    buildFFmpegArgs(url, opt) {
        // 解析尺寸参数
        let sizeArg = opt.s;
        if (opt.s === '360p')
            sizeArg = '640x360';
        else if (opt.s === '480p')
            sizeArg = '854x480';
        else if (opt.s === '720p')
            sizeArg = '1280x720';
        else if (opt.s === '1080p')
            sizeArg = '1920x1080';
        // 基本参数
        const args = [
            '-i', url,
            '-c:v', 'libx264',
            '-crf', opt.q.toString(),
            '-preset', opt.preset,
            '-r', opt.r.toString(),
            '-s', sizeArg,
            '-b:v', `${opt.br}k`
        ];
        // 输出格式特定参数
        if (opt.fmt === 'mp4') {
            args.push('-c:a', 'aac', '-b:a', '128k', '-movflags', '+faststart', '-f', 'mp4');
        }
        else if (opt.fmt === 'webm') {
            args.push('-c:v', 'libvpx', '-c:a', 'libvorbis', '-f', 'webm');
        }
        else if (opt.fmt === 'hls') {
            args.push('-c:a', 'aac', '-b:a', '128k', '-f', 'hls', '-hls_time', '4', '-hls_playlist_type', 'vod', '-hls_list_size', '0');
        }
        // 添加音频处理参数
        args.push('-ac', '2'); // 双声道音频
        // 输出到管道
        args.push('pipe:1');
        return args;
    }
    getContentType(format) {
        switch (format) {
            case 'mp4': return 'video/mp4';
            case 'webm': return 'video/webm';
            case 'hls': return 'application/vnd.apple.mpegurl';
            default: return 'video/mp4';
        }
    }
    executeFFmpeg(args) {
        console.log(`执行ffmpeg命令: ffmpeg ${args.join(' ')}`);
        const child = child_process.spawn('ffmpeg', args);
        return new Promise((resolve, reject) => {
            const _stdout = [];
            let stdoutLen = 0;
            const MAX_BUFFER = 100 * 1024 * 1024; // 100MB限制
            // 记录stderr以便调试
            let stderr = '';
            if (child.stderr) {
                child.stderr.on('data', (chunk) => {
                    stderr += chunk.toString();
                });
            }
            if (child.stdout) {
                child.stdout.on('data', function onChildStdout(chunk) {
                    stdoutLen += chunk.length;
                    if (stdoutLen > MAX_BUFFER) {
                        child.kill('SIGTERM');
                        reject(new Error('Exceed max buffer size'));
                    }
                    else {
                        _stdout.push(chunk);
                    }
                });
            }
            else {
                reject(new Error("Can't create stdout"));
                return;
            }
            child.on('error', (err) => {
                console.error(`FFmpeg错误: ${err.message}`);
                reject(err);
            });
            child.on('close', (code, signal) => {
                if (code === 0 && signal === null) {
                    resolve(Buffer.concat(_stdout));
                }
                else {
                    console.error(`FFmpeg退出码: ${code}, 信号: ${signal}`);
                    console.error(`错误输出: ${stderr}`);
                    reject(new Error(`FFmpeg exited with code ${code}`));
                }
            });
        });
    }
    beforeNewContext(_ctx, _params, _index) {
        // 不需要特殊处理
    }
    beforeProcess(_ctx, _params, _index) {
        // 不需要特殊处理
    }
}
exports.CompressAction = CompressAction;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcHJlc3MuYWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3Byb2Nlc3Nvci92aWRlby9jb21wcmVzcy5hY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0NBQStDO0FBQy9DLDBCQUFxRTtBQWVyRSxNQUFhLGNBQWM7SUFBM0I7UUFDa0IsU0FBSSxHQUFXLFVBQVUsQ0FBQztJQTBONUMsQ0FBQztJQXhOUSxRQUFRLENBQUMsTUFBZ0I7UUFDOUIsSUFBSSxHQUFHLEdBQXNCO1lBQzNCLENBQUMsRUFBRSxFQUFFO1lBQ0wsQ0FBQyxFQUFFLEVBQUU7WUFDTCxDQUFDLEVBQUUsTUFBTTtZQUNULEVBQUUsRUFBRSxJQUFJO1lBQ1IsR0FBRyxFQUFFLEtBQUs7WUFDVixNQUFNLEVBQUUsUUFBUSxDQUFDLFdBQVc7U0FDN0IsQ0FBQztRQUVGLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDckMsU0FBUzthQUNWO1lBRUQsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxDQUFDO2dCQUFFLFNBQVM7WUFFakIsUUFBUSxDQUFDLEVBQUU7Z0JBQ1QsS0FBSyxHQUFHO29CQUNOLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDMUIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksT0FBTyxHQUFHLENBQUMsSUFBSSxPQUFPLEdBQUcsRUFBRSxFQUFFO3dCQUNqRCxNQUFNLElBQUksbUJBQWUsQ0FBQywwQkFBMEIsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO3FCQUNoRjtvQkFDRCxHQUFHLENBQUMsQ0FBQyxH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LENBQUM7YUFDSjtpQkFBTTtnQkFDTCxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDO2dCQUN6QyxPQUFPO2FBQ1I7WUFFRCxLQUFLLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUN4QixPQUFPLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7Z0JBQzFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNkLENBQUMsQ0FBQyxDQUFDO1lBRUgsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQ2pDLElBQUksSUFBSSxLQUFLLENBQUMsSUFBSSxNQUFNLEtBQUssSUFBSSxFQUFFO29CQUNqQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2lCQUNqQztxQkFBTTtvQkFDTCxPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsSUFBSSxTQUFTLE1BQU0sRUFBRSxDQUFDLENBQUM7b0JBQ25ELE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxNQUFNLEVBQUUsQ0FBQyxDQUFDO29CQUNqQyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsMkJBQTJCLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDdEQ7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLGdCQUFnQixDQUFDLElBQTZCLEVBQUUsT0FBaUIsRUFBRSxNQUFjO1FBQ3RGLFVBQVU7SUFDWixDQUFDO0lBRU0sYUFBYSxDQUFDLElBQTZCLEVBQUUsT0FBaUIsRUFBRSxNQUFjO1FBQ25GLFVBQVU7SUFDWixDQUFDO0NBQ0Y7QUEzTkQsd0NBMk5DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2hpbGRfcHJvY2VzcyBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7IElBY3Rpb24sIEludmFsaWRBcmd1bWVudCwgSUFjdGlvbk9wdHMsIFJlYWRPbmx5IH0gZnJvbSAnLi4nO1xuaW1wb3J0IHsgSUV4dGVuZGVkUHJvY2Vzc0NvbnRleHQgfSBmcm9tICcuL2NvbnRleHQnO1xuXG4vKipcbiAqIOinhumikeWOi+e8qemAiemhueaOpeWPo1xuICovXG5leHBvcnQgaW50ZXJmYWNlIFZpZGVvQ29tcHJlc3NPcHRzIGV4dGVuZHMgSUFjdGlvbk9wdHMge1xuICBxOiBudW1iZXI7ICAgICAgIC8vIOi0qOmHj+WPguaVsCAoMS01Me+8jOWAvOi2iuWwj+i0qOmHj+i2iumrmClcbiAgcjogbnVtYmVyOyAgICAgICAvLyDovpPlh7rluKfnjodcbiAgczogc3RyaW5nOyAgICAgICAvLyDovpPlh7rlsLrlr7ggKOS+i+WmgjogJzY0MHg0ODAnLCAnNzIwcCcsICcxMDgwcCcpXG4gIGJyOiBudW1iZXI7ICAgICAgLy8g5q+U54m5546HIChrYnBzKVxuICBmbXQ6IHN0cmluZzsgICAgIC8vIOi+k+WHuuagvOW8jyAoJ21wNCcsICd3ZWJtJywgJ2hscycpXG4gIHByZXNldDogc3RyaW5nOyAgLy8g57yW56CB6aKE6K6+ICgnZmFzdCcsICdtZWRpdW0nLCAnc2xvdycpXG59XG5cbmV4cG9ydCBjbGFzcyBDb21wcmVzc0FjdGlvbiBpbXBsZW1lbnRzIElBY3Rpb24ge1xuICBwdWJsaWMgcmVhZG9ubHkgbmFtZTogc3RyaW5nID0gJ2NvbXByZXNzJztcbiAgXG4gIHB1YmxpYyB2YWxpZGF0ZShwYXJhbXM6IHN0cmluZ1tdKTogUmVhZE9ubHk8VmlkZW9Db21wcmVzc09wdHM+IHtcbiAgICBsZXQgb3B0OiBWaWRlb0NvbXByZXNzT3B0cyA9IHtcbiAgICAgIHE6IDIzLCAgICAgICAgICAgLy8g6buY6K6k6LSo6YeP5Y+C5pWwXG4gICAgICByOiAzMCwgICAgICAgICAgIC8vIOm7mOiupDMwZnBzXG4gICAgICBzOiAnNzIwcCcsICAgICAgIC8vIOm7mOiupDcyMHBcbiAgICAgIGJyOiAxNTAwLCAgICAgICAgLy8g6buY6K6kMTUwMGticHNcbiAgICAgIGZtdDogJ21wNCcsICAgICAgLy8g6buY6K6kbXA05qC85byPXG4gICAgICBwcmVzZXQ6ICdtZWRpdW0nIC8vIOm7mOiupOS4reetieWOi+e8qemAn+W6plxuICAgIH07XG4gICAgXG4gICAgZm9yIChjb25zdCBwYXJhbSBvZiBwYXJhbXMpIHtcbiAgICAgIGlmICgodGhpcy5uYW1lID09PSBwYXJhbSkgfHwgKCFwYXJhbSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IFtrLCB2XSA9IHBhcmFtLnNwbGl0KCdfJyk7XG4gICAgICBpZiAoIXYpIGNvbnRpbnVlO1xuICAgICAgXG4gICAgICBzd2l0Y2ggKGspIHtcbiAgICAgICAgY2FzZSAncSc6XG4gICAgICAgICAgY29uc3QgcXVhbGl0eSA9IE51bWJlcih2KTtcbiAgICAgICAgICBpZiAoaXNOYU4ocXVhbGl0eSkgfHwgcXVhbGl0eSA8IDEgfHwgcXVhbGl0eSA+IDUxKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KGBJbnZhbGlkIHF1YWxpdHkgdmFsdWU6ICR7dn0sIG11c3QgYmUgYmV0d2VlbiAxLTUxYCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIG9wdC5xID0gcXVhbGl0eTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgICBcbiAgICAgICAgY2FzZSAncic6XG4gICAgICAgICAgY29uc3QgZnJhbWVyYXRlID0gTnVtYmVyKHYpO1xuICAgICAgICAgIGlmIChpc05hTihmcmFtZXJhdGUpIHx8IGZyYW1lcmF0ZSA8IDEgfHwgZnJhbWVyYXRlID4gNjApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoYEludmFsaWQgZnJhbWVyYXRlIHZhbHVlOiAke3Z9LCBtdXN0IGJlIGJldHdlZW4gMS02MGApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBvcHQuciA9IGZyYW1lcmF0ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgICBcbiAgICAgICAgY2FzZSAncyc6XG4gICAgICAgICAgLy8g5pSv5oyB5bi46KeB5YiG6L6o546H5oiW6Ieq5a6a5LmJ5bC65a+4XG4gICAgICAgICAgaWYgKCFbJzM2MHAnLCAnNDgwcCcsICc3MjBwJywgJzEwODBwJ10uaW5jbHVkZXModikgJiYgXG4gICAgICAgICAgICAgICF2Lm1hdGNoKC9eXFxkK3hcXGQrJC8pKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KGBJbnZhbGlkIHNpemUgdmFsdWU6ICR7dn1gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgb3B0LnMgPSB2O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIFxuICAgICAgICBjYXNlICdicic6XG4gICAgICAgICAgY29uc3QgYml0cmF0ZSA9IE51bWJlcih2KTtcbiAgICAgICAgICBpZiAoaXNOYU4oYml0cmF0ZSkgfHwgYml0cmF0ZSA8IDEwMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudChgSW52YWxpZCBiaXRyYXRlIHZhbHVlOiAke3Z9YCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIG9wdC5iciA9IGJpdHJhdGU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgXG4gICAgICAgIGNhc2UgJ2ZtdCc6XG4gICAgICAgICAgaWYgKCFbJ21wNCcsICd3ZWJtJywgJ2hscyddLmluY2x1ZGVzKHYpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEFyZ3VtZW50KGBVbnN1cHBvcnRlZCBmb3JtYXQ6ICR7dn0sIG11c3QgYmUgbXA0LCB3ZWJtIG9yIGhsc2ApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBvcHQuZm10ID0gdjtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgICBcbiAgICAgICAgY2FzZSAncHJlc2V0JzpcbiAgICAgICAgICBpZiAoIVsndWx0cmFmYXN0JywgJ3N1cGVyZmFzdCcsICd2ZXJ5ZmFzdCcsICdmYXN0ZXInLCAnZmFzdCcsICdtZWRpdW0nLCAnc2xvdycsICdzbG93ZXInLCAndmVyeXNsb3cnXS5pbmNsdWRlcyh2KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudChgSW52YWxpZCBwcmVzZXQ6ICR7dn1gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgb3B0LnByZXNldCA9IHY7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudChgVW5rbm93biBwYXJhbWV0ZXI6ICR7a31gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIG9wdDtcbiAgfVxuICBcbiAgcHVibGljIGFzeW5jIHByb2Nlc3MoY3R4OiBJRXh0ZW5kZWRQcm9jZXNzQ29udGV4dCwgcGFyYW1zOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG9wdCA9IHRoaXMudmFsaWRhdGUocGFyYW1zKTtcbiAgICBjb25zdCB1cmwgPSBhd2FpdCBjdHguYnVmZmVyU3RvcmUudXJsKGN0eC51cmkpO1xuICAgIFxuICAgIC8vIOaehOW7umZmbXBlZ+WRveS7pOWPguaVsFxuICAgIGNvbnN0IGZmbXBlZ0FyZ3MgPSB0aGlzLmJ1aWxkRkZtcGVnQXJncyh1cmwsIG9wdCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKGDlvIDlp4vljovnvKnop4bpopE6ICR7Y3R4LnVyaX0gLSAke0pTT04uc3RyaW5naWZ5KG9wdCl9YCk7XG4gICAgICAvLyDmiafooYxmZm1wZWflpITnkIZcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmV4ZWN1dGVGRm1wZWcoZmZtcGVnQXJncyk7XG4gICAgICBjb25zb2xlLmxvZyhg6KeG6aKR5Y6L57yp5a6M5oiQOiAke2N0eC51cml9LCDovpPlh7rlpKflsI86ICR7ZGF0YS5sZW5ndGggLyAoMTAyNCAqIDEwMjQpfU1CYCk7XG4gICAgICBcbiAgICAgIC8vIOiuvue9ruWTjeW6lOaVsOaNrlxuICAgICAgY3R4LnJlc3VsdCA9IHtcbiAgICAgICAgZGF0YSxcbiAgICAgICAgdHlwZTogdGhpcy5nZXRDb250ZW50VHlwZShvcHQuZm10KVxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBjb25zb2xlLmVycm9yKGDop4bpopHljovnvKnlpLHotKU6ICR7ZXJyb3IubWVzc2FnZSB8fCAn5pyq55+l6ZSZ6K+vJ31gKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuICBcbiAgcHJpdmF0ZSBidWlsZEZGbXBlZ0FyZ3ModXJsOiBzdHJpbmcsIG9wdDogVmlkZW9Db21wcmVzc09wdHMpOiBzdHJpbmdbXSB7XG4gICAgLy8g6Kej5p6Q5bC65a+45Y+C5pWwXG4gICAgbGV0IHNpemVBcmcgPSBvcHQucztcbiAgICBpZiAob3B0LnMgPT09ICczNjBwJykgc2l6ZUFyZyA9ICc2NDB4MzYwJztcbiAgICBlbHNlIGlmIChvcHQucyA9PT0gJzQ4MHAnKSBzaXplQXJnID0gJzg1NHg0ODAnO1xuICAgIGVsc2UgaWYgKG9wdC5zID09PSAnNzIwcCcpIHNpemVBcmcgPSAnMTI4MHg3MjAnO1xuICAgIGVsc2UgaWYgKG9wdC5zID09PSAnMTA4MHAnKSBzaXplQXJnID0gJzE5MjB4MTA4MCc7XG4gICAgXG4gICAgLy8g5Z+65pys5Y+C5pWwXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctaScsIHVybCxcbiAgICAgICctYzp2JywgJ2xpYngyNjQnLFxuICAgICAgJy1jcmYnLCBvcHQucS50b1N0cmluZygpLFxuICAgICAgJy1wcmVzZXQnLCBvcHQucHJlc2V0LFxuICAgICAgJy1yJywgb3B0LnIudG9TdHJpbmcoKSxcbiAgICAgICctcycsIHNpemVBcmcsXG4gICAgICAnLWI6dicsIGAke29wdC5icn1rYFxuICAgIF07XG4gICAgXG4gICAgLy8g6L6T5Ye65qC85byP54m55a6a5Y+C5pWwXG4gICAgaWYgKG9wdC5mbXQgPT09ICdtcDQnKSB7XG4gICAgICBhcmdzLnB1c2goXG4gICAgICAgICctYzphJywgJ2FhYycsXG4gICAgICAgICctYjphJywgJzEyOGsnLFxuICAgICAgICAnLW1vdmZsYWdzJywgJytmYXN0c3RhcnQnLFxuICAgICAgICAnLWYnLCAnbXA0J1xuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKG9wdC5mbXQgPT09ICd3ZWJtJykge1xuICAgICAgYXJncy5wdXNoKFxuICAgICAgICAnLWM6dicsICdsaWJ2cHgnLFxuICAgICAgICAnLWM6YScsICdsaWJ2b3JiaXMnLFxuICAgICAgICAnLWYnLCAnd2VibSdcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChvcHQuZm10ID09PSAnaGxzJykge1xuICAgICAgYXJncy5wdXNoKFxuICAgICAgICAnLWM6YScsICdhYWMnLFxuICAgICAgICAnLWI6YScsICcxMjhrJyxcbiAgICAgICAgJy1mJywgJ2hscycsXG4gICAgICAgICctaGxzX3RpbWUnLCAnNCcsXG4gICAgICAgICctaGxzX3BsYXlsaXN0X3R5cGUnLCAndm9kJyxcbiAgICAgICAgJy1obHNfbGlzdF9zaXplJywgJzAnXG4gICAgICApO1xuICAgIH1cbiAgICBcbiAgICAvLyDmt7vliqDpn7PpopHlpITnkIblj4LmlbBcbiAgICBhcmdzLnB1c2goJy1hYycsICcyJyk7IC8vIOWPjOWjsOmBk+mfs+mikVxuICAgIFxuICAgIC8vIOi+k+WHuuWIsOeuoemBk1xuICAgIGFyZ3MucHVzaCgncGlwZToxJyk7XG4gICAgXG4gICAgcmV0dXJuIGFyZ3M7XG4gIH1cbiAgXG4gIHByaXZhdGUgZ2V0Q29udGVudFR5cGUoZm9ybWF0OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHN3aXRjaCAoZm9ybWF0KSB7XG4gICAgICBjYXNlICdtcDQnOiByZXR1cm4gJ3ZpZGVvL21wNCc7XG4gICAgICBjYXNlICd3ZWJtJzogcmV0dXJuICd2aWRlby93ZWJtJztcbiAgICAgIGNhc2UgJ2hscyc6IHJldHVybiAnYXBwbGljYXRpb24vdm5kLmFwcGxlLm1wZWd1cmwnO1xuICAgICAgZGVmYXVsdDogcmV0dXJuICd2aWRlby9tcDQnO1xuICAgIH1cbiAgfVxuICBcbiAgcHJpdmF0ZSBleGVjdXRlRkZtcGVnKGFyZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTxCdWZmZXI+IHtcbiAgICBjb25zb2xlLmxvZyhg5omn6KGMZmZtcGVn5ZG95LukOiBmZm1wZWcgJHthcmdzLmpvaW4oJyAnKX1gKTtcbiAgICBjb25zdCBjaGlsZCA9IGNoaWxkX3Byb2Nlc3Muc3Bhd24oJ2ZmbXBlZycsIGFyZ3MpO1xuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxCdWZmZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IF9zdGRvdXQ6IGFueVtdID0gW107XG4gICAgICBsZXQgc3Rkb3V0TGVuID0gMDtcbiAgICAgIGNvbnN0IE1BWF9CVUZGRVIgPSAxMDAgKiAxMDI0ICogMTAyNDsgLy8gMTAwTULpmZDliLZcbiAgICAgIFxuICAgICAgLy8g6K6w5b2Vc3RkZXJy5Lul5L6/6LCD6K+VXG4gICAgICBsZXQgc3RkZXJyID0gJyc7XG4gICAgICBpZiAoY2hpbGQuc3RkZXJyKSB7XG4gICAgICAgIGNoaWxkLnN0ZGVyci5vbignZGF0YScsIChjaHVuaykgPT4ge1xuICAgICAgICAgIHN0ZGVyciArPSBjaHVuay50b1N0cmluZygpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaWYgKGNoaWxkLnN0ZG91dCkge1xuICAgICAgICBjaGlsZC5zdGRvdXQub24oJ2RhdGEnLCBmdW5jdGlvbiBvbkNoaWxkU3Rkb3V0KGNodW5rKSB7XG4gICAgICAgICAgc3Rkb3V0TGVuICs9IGNodW5rLmxlbmd0aDtcbiAgICAgICAgICBpZiAoc3Rkb3V0TGVuID4gTUFYX0JVRkZFUikge1xuICAgICAgICAgICAgY2hpbGQua2lsbCgnU0lHVEVSTScpO1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignRXhjZWVkIG1heCBidWZmZXIgc2l6ZScpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgX3N0ZG91dC5wdXNoKGNodW5rKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihcIkNhbid0IGNyZWF0ZSBzdGRvdXRcIikpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNoaWxkLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRkZtcGVn6ZSZ6K+vOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBjaGlsZC5vbignY2xvc2UnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIGlmIChjb2RlID09PSAwICYmIHNpZ25hbCA9PT0gbnVsbCkge1xuICAgICAgICAgIHJlc29sdmUoQnVmZmVyLmNvbmNhdChfc3Rkb3V0KSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgRkZtcGVn6YCA5Ye656CBOiAke2NvZGV9LCDkv6Hlj7c6ICR7c2lnbmFsfWApO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYOmUmeivr+i+k+WHujogJHtzdGRlcnJ9YCk7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgRkZtcGVnIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfWApKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgXG4gIHB1YmxpYyBiZWZvcmVOZXdDb250ZXh0KF9jdHg6IElFeHRlbmRlZFByb2Nlc3NDb250ZXh0LCBfcGFyYW1zOiBzdHJpbmdbXSwgX2luZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICAvLyDkuI3pnIDopoHnibnmrorlpITnkIZcbiAgfVxuICBcbiAgcHVibGljIGJlZm9yZVByb2Nlc3MoX2N0eDogSUV4dGVuZGVkUHJvY2Vzc0NvbnRleHQsIF9wYXJhbXM6IHN0cmluZ1tdLCBfaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIC8vIOS4jemcgOimgeeJueauiuWkhOeQhlxuICB9XG59XG4iXX0=