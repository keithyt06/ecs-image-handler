"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const S3 = require("aws-sdk/clients/s3");
const SecretsManager = require("aws-sdk/clients/secretsmanager");
const SSM = require("aws-sdk/clients/ssm");
const Koa = require("koa");
const bodyParser = require("koa-bodyparser");
const koaCash = require("koa-cash");
const logger = require("koa-logger");
const Router = require("koa-router");
const lru_cache_1 = require("lru-cache");
const sharp = require("sharp");
const config_1 = require("./config");
const debug_1 = require("./debug");
const default_1 = require("./default");
const is = require("./is");
const processor_1 = require("./processor");
const MB = 1048576;
const ssm = new SSM({ region: config_1.default.region });
const smclient = new SecretsManager({ region: config_1.default.region });
// Initialize buffer stores for all configured buckets
const bufferStores = (0, default_1.getBufferStores)();
const DefaultBufferStore = (0, default_1.bufferStore)();
const app = new Koa();
const router = new Router();
const lruCache = new lru_cache_1.LRUCache({
    max: config_1.default.CACHE_MAX_ITEMS,
    maxSize: config_1.default.CACHE_MAX_SIZE_MB * MB,
    ttl: config_1.default.CACHE_TTL_SEC * 1000,
    sizeCalculation: (value) => {
        return value.body.length;
    },
});
sharp.cache({ items: 1000, files: 200, memory: 2000 });
app.use(logger());
app.use(errorHandler());
app.use(bodyParser());
app.use(koaCash({
    setCachedHeader: true,
    hash(ctx) {
        return ctx.headers['x-bucket'] + ctx.request.url;
    },
    get: (key) => {
        return Promise.resolve(lruCache.get(key));
    },
    set: (key, value) => {
        lruCache.set(key, value);
        return Promise.resolve();
    },
}));
router.post('/images', async (ctx) => {
    console.log('post request body=', ctx.request.body);
    const opt = await validatePostRequest(ctx);
    ctx.path = opt.sourceObject;
    ctx.query['x-oss-process'] = opt.params;
    ctx.headers['x-bucket'] = opt.sourceBucket;
    const { data, type } = await ossprocess(ctx);
    if (type !== 'application/json') {
        // TODO: Do we need to abstract this with IBufferStore?
        const _s3 = new S3({ region: config_1.default.region });
        await _s3.putObject({
            Bucket: opt.targetBucket,
            Key: opt.targetObject,
            ContentType: type,
            Body: data,
        }).promise();
        ctx.body = `saved result to s3://${opt.targetBucket}/${opt.targetObject}`;
    }
});
router.get(['/', '/ping'], async (ctx) => {
    ctx.body = 'ok';
    try {
        await setMaxGifLimit();
    }
    catch (err) {
        console.error(err);
    }
});
router.get(['/debug', '/_debug'], async (ctx) => {
    console.log(JSON.stringify((0, debug_1.default)(lruCache)));
    ctx.status = 400;
    ctx.body = 'Please check your server logs for more details!';
});
router.get('/(.*)', async (ctx) => {
    if (await ctx.cashed())
        return;
    const queue = sharp.counters().queue;
    if (queue > config_1.default.sharpQueueLimit) {
        ctx.body = { message: 'Too many requests, please try again later.' };
        ctx.status = 429;
        return;
    }
    // 检查Accept头是否包含image/avif
    const acceptHeader = ctx.get('Accept') || '';
    const acceptsAvif = acceptHeader.includes('image/avif');
    // 如果客户端支持AVIF并且配置启用了自动AVIF
    if (acceptsAvif && config_1.default.autoAvif) {
        ctx.features = ctx.features || {};
        ctx.features[processor_1.Features.AutoAvif] = true;
    }
    const { data, type, headers } = await ossprocess(ctx);
    ctx.body = data;
    ctx.type = type;
    ctx.set(headers);
});
app.use(router.routes());
app.use(router.allowedMethods());
app.on('error', (err) => {
    const msg = err.stack || err.toString();
    console.error(`\n${msg.replace(/^/gm, '  ')}\n`);
});
app.listen(config_1.default.port, () => {
    console.log(`Server running on port ${config_1.default.port}`);
    console.log('Config:', JSON.stringify(config_1.default));
});
function errorHandler() {
    return async (ctx, next) => {
        try {
            await next();
        }
        catch (err) {
            // ENOENT support
            if (err.code === 'ENOENT') {
                err.status = 404;
                err.message = 'NotFound';
            }
            ctx.status = err.statusCode || err.status || 500;
            ctx.body = {
                status: err.status,
                name: err.name,
                message: err.message,
            };
            ctx.app.emit('error', err, ctx);
        }
    };
}
function getBufferStore(ctx) {
    const bucket = ctx.headers['x-bucket'];
    if (bucket && typeof bucket === 'string') {
        // Check if we have a store for this bucket
        const store = bufferStores.get(bucket);
        if (store) {
            return store;
        }
        // If the bucket is not in our pre-configured list but is specified in the request,
        // create a new store for it (this allows dynamic bucket access)
        const newStore = (0, default_1.bufferStore)(bucket);
        bufferStores.set(bucket, newStore);
        return newStore;
    }
    return DefaultBufferStore;
}
async function ossprocess(ctx) {
    const { uri, actions } = (0, default_1.parseRequest)(ctx.path, ctx.query);
    // 只通过 x-bucket 头选择存储桶，不再解析路径
    const bs = getBufferStore(ctx);
    // 检查是否有处理操作
    if (actions.length > 1) {
        console.log(`Processing image with ${actions.length - 1} actions`);
        const processor = (0, default_1.getProcessor)(actions[0]);
        const context = await processor.newContext(uri, actions, bs);
        // 如果客户端支持AVIF并且配置启用了自动AVIF
        if (ctx.features && ctx.features[processor_1.Features.AutoAvif]) {
            context.features[processor_1.Features.AutoAvif] = true;
        }
        const { data, type } = await processor.process(context);
        return { data, type, headers: context.headers };
    }
    else {
        console.log(`Direct access to image: ${uri}`);
        // 直接访问图像，不再需要bypass函数
        const { buffer, type, headers } = await bs.get(uri);
        return { data: buffer, type: type, headers: headers };
    }
}
async function validatePostRequest(ctx) {
    // Fox edited in 2022/04/25: enhance the security of the post requests
    const authHeader = ctx.get('X-Client-Authorization');
    const secretHeader = await getHeaderFromSecretsManager();
    if (authHeader !== secretHeader) {
        throw new processor_1.InvalidArgument('Invalid post header.');
    }
    const body = ctx.request.body;
    if (!body) {
        throw new processor_1.InvalidArgument('Empty post body.');
    }
    const valid = body.params
        && body.sourceBucket
        && body.sourceObject
        && body.targetBucket
        && body.targetObject;
    if (!valid) {
        throw new processor_1.InvalidArgument('Invalid post body.');
    }
    return {
        params: body.params,
        sourceBucket: body.sourceBucket,
        sourceObject: body.sourceObject,
        targetBucket: body.targetBucket,
        targetObject: body.targetObject,
    };
}
async function getSecretFromSecretsManager() {
    // Load the AWS SDK
    const secretName = config_1.default.secretName;
    return smclient.getSecretValue({ SecretId: secretName }).promise();
}
async function getHeaderFromSecretsManager() {
    const secret = await getSecretFromSecretsManager();
    const secretString = secret.SecretString;
    const keypair = JSON.parse(secretString);
    return keypair['X-Client-Authorization'];
}
async function setMaxGifLimit() {
    var _a;
    if (config_1.default.configJsonParameterName) {
        const data = await ssm.getParameter({ Name: config_1.default.configJsonParameterName }).promise();
        if (data.Parameter) {
            const configJson = JSON.parse((_a = data.Parameter.Value) !== null && _a !== void 0 ? _a : '{}');
            const maxGifSizeMB = configJson.max_gif_size_mb;
            if (is.number(maxGifSizeMB)) {
                (0, default_1.setMaxGifSizeMB)(maxGifSizeMB);
            }
            const maxGifPages = configJson.max_gif_pages;
            if (is.number(maxGifPages)) {
                (0, default_1.setMaxGifPages)(maxGifPages);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5Q0FBeUM7QUFDekMsaUVBQWlFO0FBQ2pFLDJDQUEyQztBQUMzQywyQkFBMkI7QUFDM0IsNkNBQTZDO0FBQzdDLG9DQUFvQztBQUNwQyxxQ0FBcUM7QUFDckMscUNBQXFDO0FBQ3JDLHlDQUFxQztBQUNyQywrQkFBK0I7QUFDL0IscUNBQThCO0FBQzlCLG1DQUE0QjtBQUM1Qix1Q0FBc0g7QUFDdEgsMkJBQTJCO0FBQzNCLDJDQUFzRTtBQWV0RSxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUM7QUFFbkIsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsRUFBRSxNQUFNLEVBQUUsZ0JBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBQy9DLE1BQU0sUUFBUSxHQUFHLElBQUksY0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLGdCQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUUvRCxzREFBc0Q7QUFDdEQsTUFBTSxZQUFZLEdBQUcsSUFBQSx5QkFBZSxHQUFFLENBQUM7QUFDdkMsTUFBTSxrQkFBa0IsR0FBRyxJQUFBLHFCQUFXLEdBQUUsQ0FBQztBQUV6QyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7QUFDNUIsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFzQjtJQUNqRCxHQUFHLEVBQUUsZ0JBQU0sQ0FBQyxlQUFlO0lBQzNCLE9BQU8sRUFBRSxnQkFBTSxDQUFDLGlCQUFpQixHQUFHLEVBQUU7SUFDdEMsR0FBRyxFQUFFLGdCQUFNLENBQUMsYUFBYSxHQUFHLElBQUk7SUFDaEMsZUFBZSxFQUFFLENBQUMsS0FBa0IsRUFBRSxFQUFFO1FBQ3RDLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxN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YXdzLXNkay9jbGllbnRzL3MzJztcbmltcG9ydCAqIGFzIFNlY3JldHNNYW5hZ2VyIGZyb20gJ2F3cy1zZGsvY2xpZW50cy9zZWNyZXRzbWFuYWdlcic7XG5pbXBvcnQgKiBhcyBTU00gZnJvbSAnYXdzLXNkay9jbGllbnRzL3NzbSc7XG5pbXBvcnQgKiBhcyBLb2EgZnJvbSAna29hJztcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSAna29hLWJvZHlwYXJzZXInO1xuaW1wb3J0ICogYXMga29hQ2FzaCBmcm9tICdrb2EtY2FzaCc7XG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAna29hLWxvZ2dlcic7XG5pbXBvcnQgKiBhcyBSb3V0ZXIgZnJvbSAna29hLXJvdXRlcic7XG5pbXBvcnQgeyBMUlVDYWNoZSB9IGZyb20gJ2xydS1jYWNoZSc7XG5pbXBvcnQgKiBhcyBzaGFycCBmcm9tICdzaGFycCc7XG5pbXBvcnQgY29uZmlnIGZyb20gJy4vY29uZmlnJztcbmltcG9ydCBkZWJ1ZyBmcm9tICcuL2RlYnVnJztcbmltcG9ydCB7IGJ1ZmZlclN0b3JlLCBnZXRCdWZmZXJTdG9yZXMsIGdldFByb2Nlc3NvciwgcGFyc2VSZXF1ZXN0LCBzZXRNYXhHaWZTaXplTUIsIHNldE1heEdpZlBhZ2VzIH0gZnJvbSAnLi9kZWZhdWx0JztcbmltcG9ydCAqIGFzIGlzIGZyb20gJy4vaXMnO1xuaW1wb3J0IHsgRmVhdHVyZXMsIElIdHRwSGVhZGVycywgSW52YWxpZEFyZ3VtZW50IH0gZnJvbSAnLi9wcm9jZXNzb3InO1xuaW1wb3J0IHsgSUJ1ZmZlclN0b3JlIH0gZnJvbSAnLi9zdG9yZSc7XG5cbi8vIOWumuS5ieS4gOS4quaOpeWPo+adpeaJqeWxlUtvYeS4iuS4i+aWh1xuaW50ZXJmYWNlIEV4dGVuZGVkQ29udGV4dCBleHRlbmRzIEtvYS5QYXJhbWV0ZXJpemVkQ29udGV4dCB7XG4gIGZlYXR1cmVzPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbn1cblxuLy8g5a6a5LmJ57yT5a2Y5a+56LGh5o6l5Y+jXG5pbnRlcmZhY2UgQ2FjaGVPYmplY3Qge1xuICBib2R5OiBhbnk7XG4gIHR5cGU6IHN0cmluZztcbiAgaGVhZGVyczogSUh0dHBIZWFkZXJzO1xufVxuXG5jb25zdCBNQiA9IDEwNDg1NzY7XG5cbmNvbnN0IHNzbSA9IG5ldyBTU00oeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSk7XG5jb25zdCBzbWNsaWVudCA9IG5ldyBTZWNyZXRzTWFuYWdlcih7IHJlZ2lvbjogY29uZmlnLnJlZ2lvbiB9KTtcblxuLy8gSW5pdGlhbGl6ZSBidWZmZXIgc3RvcmVzIGZvciBhbGwgY29uZmlndXJlZCBidWNrZXRzXG5jb25zdCBidWZmZXJTdG9yZXMgPSBnZXRCdWZmZXJTdG9yZXMoKTtcbmNvbnN0IERlZmF1bHRCdWZmZXJTdG9yZSA9IGJ1ZmZlclN0b3JlKCk7XG5cbmNvbnN0IGFwcCA9IG5ldyBLb2EoKTtcbmNvbnN0IHJvdXRlciA9IG5ldyBSb3V0ZXIoKTtcbmNvbnN0IGxydUNhY2hlID0gbmV3IExSVUNhY2hlPHN0cmluZywgQ2FjaGVPYmplY3Q+KHtcbiAgbWF4OiBjb25maWcuQ0FDSEVfTUFYX0lURU1TLFxuICBtYXhTaXplOiBjb25maWcuQ0FDSEVfTUFYX1NJWkVfTUIgKiBNQixcbiAgdHRsOiBjb25maWcuQ0FDSEVfVFRMX1NFQyAqIDEwMDAsXG4gIHNpemVDYWxjdWxhdGlvbjogKHZhbHVlOiBDYWNoZU9iamVjdCkgPT4ge1xuICAgIHJldHVybiB2YWx1ZS5ib2R5Lmxlbmd0aDtcbiAgfSxcbn0pO1xuXG5zaGFycC5jYWNoZSh7IGl0ZW1zOiAxMDAwLCBmaWxlczogMjAwLCBtZW1vcnk6IDIwMDAgfSk7XG5cbmFwcC51c2UobG9nZ2VyKCkpO1xuYXBwLnVzZShlcnJvckhhbmRsZXIoKSk7XG5hcHAudXNlKGJvZHlQYXJzZXIoKSk7XG5hcHAudXNlKGtvYUNhc2goe1xuICBzZXRDYWNoZWRIZWFkZXI6IHRydWUsXG4gIGhhc2goY3R4KSB7XG4gICAgcmV0dXJuIGN0eC5oZWFkZXJzWyd4LWJ1Y2tldCddICsgY3R4LnJlcXVlc3QudXJsO1xuICB9LFxuICBnZXQ6IChrZXkpID0+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGxydUNhY2hlLmdldChrZXkpKTtcbiAgfSxcbiAgc2V0OiAoa2V5LCB2YWx1ZSkgPT4ge1xuICAgIGxydUNhY2hlLnNldChrZXksIHZhbHVlIGFzIENhY2hlT2JqZWN0KTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH0sXG59KSk7XG5cbnJvdXRlci5wb3N0KCcvaW1hZ2VzJywgYXN5bmMgKGN0eCkgPT4ge1xuICBjb25zb2xlLmxvZygncG9zdCByZXF1ZXN0IGJvZHk9JywgY3R4LnJlcXVlc3QuYm9keSk7XG5cbiAgY29uc3Qgb3B0ID0gYXdhaXQgdmFsaWRhdGVQb3N0UmVxdWVzdChjdHgpO1xuICBjdHgucGF0aCA9IG9wdC5zb3VyY2VPYmplY3Q7XG4gIGN0eC5xdWVyeVsneC1vc3MtcHJvY2VzcyddID0gb3B0LnBhcmFtcztcbiAgY3R4LmhlYWRlcnNbJ3gtYnVja2V0J10gPSBvcHQuc291cmNlQnVja2V0O1xuXG4gIGNvbnN0IHsgZGF0YSwgdHlwZSB9ID0gYXdhaXQgb3NzcHJvY2VzcyhjdHgpO1xuICBpZiAodHlwZSAhPT0gJ2FwcGxpY2F0aW9uL2pzb24nKSB7XG4gICAgLy8gVE9ETzogRG8gd2UgbmVlZCB0byBhYnN0cmFjdCB0aGlzIHdpdGggSUJ1ZmZlclN0b3JlP1xuICAgIGNvbnN0IF9zMzogUzMgPSBuZXcgUzMoeyByZWdpb246IGNvbmZpZy5yZWdpb24gfSk7XG4gICAgYXdhaXQgX3MzLnB1dE9iamVjdCh7XG4gICAgICBCdWNrZXQ6IG9wdC50YXJnZXRCdWNrZXQsXG4gICAgICBLZXk6IG9wdC50YXJnZXRPYmplY3QsXG4gICAgICBDb250ZW50VHlwZTogdHlwZSxcbiAgICAgIEJvZHk6IGRhdGEsXG4gICAgfSkucHJvbWlzZSgpO1xuXG4gICAgY3R4LmJvZHkgPSBgc2F2ZWQgcmVzdWx0IHRvIHMzOi8vJHtvcHQudGFyZ2V0QnVja2V0fS8ke29wdC50YXJnZXRPYmplY3R9YDtcbiAgfVxufSk7XG5cbnJvdXRlci5nZXQoWycvJywgJy9waW5nJ10sIGFzeW5jIChjdHgpID0+IHtcbiAgY3R4LmJvZHkgPSAnb2snO1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgc2V0TWF4R2lmTGltaXQoKTtcbiAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKGVycik7XG4gIH1cbn0pO1xuXG5yb3V0ZXIuZ2V0KFsnL2RlYnVnJywgJy9fZGVidWcnXSwgYXN5bmMgKGN0eCkgPT4ge1xuICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShkZWJ1ZyhscnVDYWNoZSkpKTtcbiAgY3R4LnN0YXR1cyA9IDQwMDtcbiAgY3R4LmJvZHkgPSAnUGxlYXNlIGNoZWNrIHlvdXIgc2VydmVyIGxvZ3MgZm9yIG1vcmUgZGV0YWlscyEnO1xufSk7XG5cbnJvdXRlci5nZXQoJy8oLiopJywgYXN5bmMgKGN0eDogRXh0ZW5kZWRDb250ZXh0KSA9PiB7XG4gIGlmIChhd2FpdCBjdHguY2FzaGVkKCkpIHJldHVybjtcblxuICBjb25zdCBxdWV1ZSA9IHNoYXJwLmNvdW50ZXJzKCkucXVldWU7XG4gIGlmIChxdWV1ZSA+IGNvbmZpZy5zaGFycFF1ZXVlTGltaXQpIHtcbiAgICBjdHguYm9keSA9IHsgbWVzc2FnZTogJ1RvbyBtYW55IHJlcXVlc3RzLCBwbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicgfTtcbiAgICBjdHguc3RhdHVzID0gNDI5O1xuICAgIHJldHVybjtcbiAgfVxuICBcbiAgLy8g5qOA5p+lQWNjZXB05aS05piv5ZCm5YyF5ZCraW1hZ2UvYXZpZlxuICBjb25zdCBhY2NlcHRIZWFkZXIgPSBjdHguZ2V0KCdBY2NlcHQnKSB8fCAnJztcbiAgY29uc3QgYWNjZXB0c0F2aWYgPSBhY2NlcHRIZWFkZXIuaW5jbHVkZXMoJ2ltYWdlL2F2aWYnKTtcbiAgXG4gIC8vIOWmguaenOWuouaIt+err+aUr+aMgUFWSUblubbkuJTphY3nva7lkK/nlKjkuoboh6rliqhBVklGXG4gIGlmIChhY2NlcHRzQXZpZiAmJiBjb25maWcuYXV0b0F2aWYpIHtcbiAgICBjdHguZmVhdHVyZXMgPSBjdHguZmVhdHVyZXMgfHwge307XG4gICAgY3R4LmZlYXR1cmVzW0ZlYXR1cmVzLkF1dG9BdmlmXSA9IHRydWU7XG4gIH1cbiAgXG4gIGNvbnN0IHsgZGF0YSwgdHlwZSwgaGVhZGVycyB9ID0gYXdhaXQgb3NzcHJvY2VzcyhjdHgpO1xuICBjdHguYm9keSA9IGRhdGE7XG4gIGN0eC50eXBlID0gdHlwZTtcbiAgY3R4LnNldChoZWFkZXJzKTtcbn0pO1xuXG5hcHAudXNlKHJvdXRlci5yb3V0ZXMoKSk7XG5hcHAudXNlKHJvdXRlci5hbGxvd2VkTWV0aG9kcygpKTtcblxuYXBwLm9uKCdlcnJvcicsIChlcnI6IEVycm9yKSA9PiB7XG4gIGNvbnN0IG1zZyA9IGVyci5zdGFjayB8fCBlcnIudG9TdHJpbmcoKTtcbiAgY29uc29sZS5lcnJvcihgXFxuJHttc2cucmVwbGFjZSgvXi9nbSwgJyAgJyl9XFxuYCk7XG59KTtcblxuYXBwLmxpc3Rlbihjb25maWcucG9ydCwgKCkgPT4ge1xuICBjb25zb2xlLmxvZyhgU2VydmVyIHJ1bm5pbmcgb24gcG9ydCAke2NvbmZpZy5wb3J0fWApO1xuICBjb25zb2xlLmxvZygnQ29uZmlnOicsIEpTT04uc3RyaW5naWZ5KGNvbmZpZykpO1xufSk7XG5cbmZ1bmN0aW9uIGVycm9ySGFuZGxlcigpOiBLb2EuTWlkZGxld2FyZTxLb2EuRGVmYXVsdFN0YXRlLCBLb2EuRGVmYXVsdENvbnRleHQsIGFueT4ge1xuICByZXR1cm4gYXN5bmMgKGN0eCwgbmV4dCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBuZXh0KCk7XG4gICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgIC8vIEVOT0VOVCBzdXBwb3J0XG4gICAgICBpZiAoZXJyLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAgIGVyci5zdGF0dXMgPSA0MDQ7XG4gICAgICAgIGVyci5tZXNzYWdlID0gJ05vdEZvdW5kJztcbiAgICAgIH1cbiAgICAgIGN0eC5zdGF0dXMgPSBlcnIuc3RhdHVzQ29kZSB8fCBlcnIuc3RhdHVzIHx8IDUwMDtcbiAgICAgIGN0eC5ib2R5ID0ge1xuICAgICAgICBzdGF0dXM6IGVyci5zdGF0dXMsXG4gICAgICAgIG5hbWU6IGVyci5uYW1lLFxuICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcbiAgICAgIH07XG5cbiAgICAgIGN0eC5hcHAuZW1pdCgnZXJyb3InLCBlcnIsIGN0eCk7XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRCdWZmZXJTdG9yZShjdHg6IEV4dGVuZGVkQ29udGV4dCk6IElCdWZmZXJTdG9yZSB7XG4gIGNvbnN0IGJ1Y2tldCA9IGN0eC5oZWFkZXJzWyd4LWJ1Y2tldCddO1xuICBpZiAoYnVja2V0ICYmIHR5cGVvZiBidWNrZXQgPT09ICdzdHJpbmcnKSB7XG4gICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBhIHN0b3JlIGZvciB0aGlzIGJ1Y2tldFxuICAgIGNvbnN0IHN0b3JlID0gYnVmZmVyU3RvcmVzLmdldChidWNrZXQpO1xuICAgIGlmIChzdG9yZSkge1xuICAgICAgcmV0dXJuIHN0b3JlO1xuICAgIH1cbiAgICBcbiAgICAvLyBJZiB0aGUgYnVja2V0IGlzIG5vdCBpbiBvdXIgcHJlLWNvbmZpZ3VyZWQgbGlzdCBidXQgaXMgc3BlY2lmaWVkIGluIHRoZSByZXF1ZXN0LFxuICAgIC8vIGNyZWF0ZSBhIG5ldyBzdG9yZSBmb3IgaXQgKHRoaXMgYWxsb3dzIGR5bmFtaWMgYnVja2V0IGFjY2VzcylcbiAgICBjb25zdCBuZXdTdG9yZSA9IGJ1ZmZlclN0b3JlKGJ1Y2tldCk7XG4gICAgYnVmZmVyU3RvcmVzLnNldChidWNrZXQsIG5ld1N0b3JlKTtcbiAgICByZXR1cm4gbmV3U3RvcmU7XG4gIH1cbiAgcmV0dXJuIERlZmF1bHRCdWZmZXJTdG9yZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gb3NzcHJvY2VzcyhjdHg6IEV4dGVuZGVkQ29udGV4dCk6XG5Qcm9taXNlPHsgZGF0YTogYW55OyB0eXBlOiBzdHJpbmc7IGhlYWRlcnM6IElIdHRwSGVhZGVycyB9PiB7XG4gIGNvbnN0IHsgdXJpLCBhY3Rpb25zIH0gPSBwYXJzZVJlcXVlc3QoY3R4LnBhdGgsIGN0eC5xdWVyeSk7XG4gIFxuICAvLyDlj6rpgJrov4cgeC1idWNrZXQg5aS06YCJ5oup5a2Y5YKo5qG277yM5LiN5YaN6Kej5p6Q6Lev5b6EXG4gIGNvbnN0IGJzID0gZ2V0QnVmZmVyU3RvcmUoY3R4KTtcbiAgXG4gIC8vIOajgOafpeaYr+WQpuacieWkhOeQhuaTjeS9nFxuICBpZiAoYWN0aW9ucy5sZW5ndGggPiAxKSB7XG4gICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgaW1hZ2Ugd2l0aCAke2FjdGlvbnMubGVuZ3RoIC0gMX0gYWN0aW9uc2ApO1xuICAgIGNvbnN0IHByb2Nlc3NvciA9IGdldFByb2Nlc3NvcihhY3Rpb25zWzBdKTtcbiAgICBjb25zdCBjb250ZXh0ID0gYXdhaXQgcHJvY2Vzc29yLm5ld0NvbnRleHQodXJpLCBhY3Rpb25zLCBicyk7XG4gICAgXG4gICAgLy8g5aaC5p6c5a6i5oi356uv5pSv5oyBQVZJRuW5tuS4lOmFjee9ruWQr+eUqOS6huiHquWKqEFWSUZcbiAgICBpZiAoY3R4LmZlYXR1cmVzICYmIGN0eC5mZWF0dXJlc1tGZWF0dXJlcy5BdXRvQXZpZl0pIHtcbiAgICAgIGNvbnRleHQuZmVhdHVyZXNbRmVhdHVyZXMuQXV0b0F2aWZdID0gdHJ1ZTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgeyBkYXRhLCB0eXBlIH0gPSBhd2FpdCBwcm9jZXNzb3IucHJvY2Vzcyhjb250ZXh0KTtcbiAgICByZXR1cm4geyBkYXRhLCB0eXBlLCBoZWFkZXJzOiBjb250ZXh0LmhlYWRlcnMgfTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgRGlyZWN0IGFjY2VzcyB0byBpbWFnZTogJHt1cml9YCk7XG4gICAgLy8g55u05o6l6K6/6Zeu5Zu+5YOP77yM5LiN5YaN6ZyA6KaBYnlwYXNz5Ye95pWwXG4gICAgY29uc3QgeyBidWZmZXIsIHR5cGUsIGhlYWRlcnMgfSA9IGF3YWl0IGJzLmdldCh1cmkpO1xuICAgIHJldHVybiB7IGRhdGE6IGJ1ZmZlciwgdHlwZTogdHlwZSwgaGVhZGVyczogaGVhZGVycyB9O1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlUG9zdFJlcXVlc3QoY3R4OiBLb2EuUGFyYW1ldGVyaXplZENvbnRleHQpIHtcbiAgLy8gRm94IGVkaXRlZCBpbiAyMDIyLzA0LzI1OiBlbmhhbmNlIHRoZSBzZWN1cml0eSBvZiB0aGUgcG9zdCByZXF1ZXN0c1xuICBjb25zdCBhdXRoSGVhZGVyID0gY3R4LmdldCgnWC1DbGllbnQtQXV0aG9yaXphdGlvbicpO1xuICBjb25zdCBzZWNyZXRIZWFkZXIgPSBhd2FpdCBnZXRIZWFkZXJGcm9tU2VjcmV0c01hbmFnZXIoKTtcblxuICBpZiAoYXV0aEhlYWRlciAhPT0gc2VjcmV0SGVhZGVyKSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnSW52YWxpZCBwb3N0IGhlYWRlci4nKTtcbiAgfVxuXG4gIGNvbnN0IGJvZHkgPSBjdHgucmVxdWVzdC5ib2R5IGFzIGFueTtcbiAgaWYgKCFib2R5KSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnRW1wdHkgcG9zdCBib2R5LicpO1xuICB9XG4gIGNvbnN0IHZhbGlkID0gYm9keS5wYXJhbXNcbiAgICAmJiBib2R5LnNvdXJjZUJ1Y2tldFxuICAgICYmIGJvZHkuc291cmNlT2JqZWN0XG4gICAgJiYgYm9keS50YXJnZXRCdWNrZXRcbiAgICAmJiBib2R5LnRhcmdldE9iamVjdDtcbiAgaWYgKCF2YWxpZCkge1xuICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ0ludmFsaWQgcG9zdCBib2R5LicpO1xuICB9XG4gIHJldHVybiB7XG4gICAgcGFyYW1zOiBib2R5LnBhcmFtcyxcbiAgICBzb3VyY2VCdWNrZXQ6IGJvZHkuc291cmNlQnVja2V0LFxuICAgIHNvdXJjZU9iamVjdDogYm9keS5zb3VyY2VPYmplY3QsXG4gICAgdGFyZ2V0QnVja2V0OiBib2R5LnRhcmdldEJ1Y2tldCxcbiAgICB0YXJnZXRPYmplY3Q6IGJvZHkudGFyZ2V0T2JqZWN0LFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTZWNyZXRGcm9tU2VjcmV0c01hbmFnZXIoKSB7XG4gIC8vIExvYWQgdGhlIEFXUyBTREtcbiAgY29uc3Qgc2VjcmV0TmFtZSA9IGNvbmZpZy5zZWNyZXROYW1lO1xuICByZXR1cm4gc21jbGllbnQuZ2V0U2VjcmV0VmFsdWUoeyBTZWNyZXRJZDogc2VjcmV0TmFtZSB9KS5wcm9taXNlKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEhlYWRlckZyb21TZWNyZXRzTWFuYWdlcigpIHtcbiAgY29uc3Qgc2VjcmV0ID0gYXdhaXQgZ2V0U2VjcmV0RnJvbVNlY3JldHNNYW5hZ2VyKCk7XG4gIGNvbnN0IHNlY3JldFN0cmluZyA9IHNlY3JldC5TZWNyZXRTdHJpbmchO1xuICBjb25zdCBrZXlwYWlyID0gSlNPTi5wYXJzZShzZWNyZXRTdHJpbmcpO1xuICByZXR1cm4ga2V5cGFpclsnWC1DbGllbnQtQXV0aG9yaXphdGlvbiddO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRNYXhHaWZMaW1pdCgpIHtcbiAgaWYgKGNvbmZpZy5jb25maWdKc29uUGFyYW1ldGVyTmFtZSkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBzc20uZ2V0UGFyYW1ldGVyKHsgTmFtZTogY29uZmlnLmNvbmZpZ0pzb25QYXJhbWV0ZXJOYW1lIH0pLnByb21pc2UoKTtcbiAgICBpZiAoZGF0YS5QYXJhbWV0ZXIpIHtcbiAgICAgIGNvbnN0IGNvbmZpZ0pzb24gPSBKU09OLnBhcnNlKGRhdGEuUGFyYW1ldGVyLlZhbHVlID8/ICd7fScpO1xuICAgICAgY29uc3QgbWF4R2lmU2l6ZU1CID0gY29uZmlnSnNvbi5tYXhfZ2lmX3NpemVfbWI7XG4gICAgICBpZiAoaXMubnVtYmVyKG1heEdpZlNpemVNQikpIHtcbiAgICAgICAgc2V0TWF4R2lmU2l6ZU1CKG1heEdpZlNpemVNQik7XG4gICAgICB9XG4gICAgICBjb25zdCBtYXhHaWZQYWdlcyA9IGNvbmZpZ0pzb24ubWF4X2dpZl9wYWdlcztcbiAgICAgIGlmIChpcy5udW1iZXIobWF4R2lmUGFnZXMpKSB7XG4gICAgICAgIHNldE1heEdpZlBhZ2VzKG1heEdpZlBhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==