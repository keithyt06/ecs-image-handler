"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const S3 = require("aws-sdk/clients/s3");
const SecretsManager = require("aws-sdk/clients/secretsmanager");
const SSM = require("aws-sdk/clients/ssm");
const HttpErrors = require("http-errors");
const Koa = require("koa"); // http://koajs.cn
const bodyParser = require("koa-bodyparser");
const koaCash = require("koa-cash");
const logger = require("koa-logger");
const Router = require("koa-router");
const lru_cache_1 = require("lru-cache");
const sharp = require("sharp");
const config_1 = require("./config");
const debug_1 = require("./debug");
const default_1 = require("./default");
const is = require("./is");
const processor_1 = require("./processor");
const MB = 1048576;
const ssm = new SSM({ region: config_1.default.region });
const smclient = new SecretsManager({ region: config_1.default.region });
// Initialize buffer stores for all configured buckets
const bufferStores = (0, default_1.getBufferStores)();
const DefaultBufferStore = (0, default_1.bufferStore)();
const app = new Koa();
const router = new Router();
const lruCache = new lru_cache_1.LRUCache({
    max: config_1.default.CACHE_MAX_ITEMS,
    maxSize: config_1.default.CACHE_MAX_SIZE_MB * MB,
    ttl: config_1.default.CACHE_TTL_SEC * 1000,
    sizeCalculation: (value) => {
        return value.body.length;
    },
});
sharp.cache({ items: 1000, files: 200, memory: 2000 });
app.use(logger());
app.use(errorHandler());
app.use(bodyParser());
app.use(koaCash({
    setCachedHeader: true,
    hash(ctx) {
        return ctx.headers['x-bucket'] + ctx.request.url;
    },
    get: (key) => {
        return Promise.resolve(lruCache.get(key));
    },
    set: (key, value) => {
        lruCache.set(key, value);
        return Promise.resolve();
    },
}));
router.post('/images', async (ctx) => {
    console.log('post request body=', ctx.request.body);
    const opt = await validatePostRequest(ctx);
    ctx.path = opt.sourceObject;
    ctx.query['x-oss-process'] = opt.params;
    ctx.headers['x-bucket'] = opt.sourceBucket;
    const { data, type } = await ossprocess(ctx);
    if (type !== 'application/json') {
        // TODO: Do we need to abstract this with IBufferStore?
        const _s3 = new S3({ region: config_1.default.region });
        await _s3.putObject({
            Bucket: opt.targetBucket,
            Key: opt.targetObject,
            ContentType: type,
            Body: data,
        }).promise();
        ctx.body = `saved result to s3://${opt.targetBucket}/${opt.targetObject}`;
    }
});
router.get(['/', '/ping'], async (ctx) => {
    ctx.body = 'ok';
    try {
        await setMaxGifLimit();
    }
    catch (err) {
        console.error(err);
    }
});
router.get(['/debug', '/_debug'], async (ctx) => {
    console.log(JSON.stringify((0, debug_1.default)(lruCache)));
    ctx.status = 400;
    ctx.body = 'Please check your server logs for more details!';
});
router.get('/(.*)', async (ctx) => {
    if (await ctx.cashed())
        return;
    const queue = sharp.counters().queue;
    if (queue > config_1.default.sharpQueueLimit) {
        ctx.body = { message: 'Too many requests, please try again later.' };
        ctx.status = 429;
        return;
    }
    // 检查Accept头是否包含image/avif
    const acceptHeader = ctx.get('Accept') || '';
    const acceptsAvif = acceptHeader.includes('image/avif');
    // 如果客户端支持AVIF并且配置启用了自动AVIF
    if (acceptsAvif && config_1.default.autoAvif) {
        ctx.features = ctx.features || {};
        ctx.features[processor_1.Features.AutoAvif] = true;
    }
    const { data, type, headers } = await ossprocess(ctx, bypass);
    ctx.body = data;
    ctx.type = type;
    ctx.set(headers);
});
app.use(router.routes());
app.use(router.allowedMethods);
app.on('error', (err) => {
    const msg = err.stack || err.toString();
    console.error(`\n${msg.replace(/^/gm, '  ')}\n`);
});
app.listen(config_1.default.port, () => {
    console.log(`Server running on port ${config_1.default.port}`);
    console.log('Config:', JSON.stringify(config_1.default));
});
function errorHandler() {
    return async (ctx, next) => {
        try {
            await next();
        }
        catch (err) {
            // ENOENT support
            if (err.code === 'ENOENT') {
                err.status = 404;
                err.message = 'NotFound';
            }
            ctx.status = err.statusCode || err.status || 500;
            ctx.body = {
                status: err.status,
                name: err.name,
                message: err.message,
            };
            ctx.app.emit('error', err, ctx);
        }
    };
}
function getBufferStore(ctx) {
    const bucket = ctx.headers['x-bucket'];
    if (bucket && typeof bucket === 'string') {
        // Check if we have a store for this bucket
        const store = bufferStores.get(bucket);
        if (store) {
            return store;
        }
        // If the bucket is not in our pre-configured list but is specified in the request,
        // create a new store for it (this allows dynamic bucket access)
        const newStore = (0, default_1.bufferStore)(bucket);
        bufferStores.set(bucket, newStore);
        return newStore;
    }
    return DefaultBufferStore;
}
async function ossprocess(ctx, beforeGetFn) {
    const { uri, actions } = (0, default_1.parseRequest)(ctx.path, ctx.query);
    // 只通过 x-bucket 头选择存储桶，不再解析路径
    const bs = getBufferStore(ctx);
    // 检查是否有处理操作
    if (actions.length > 1) {
        console.log(`Processing image with ${actions.length - 1} actions`);
        const processor = (0, default_1.getProcessor)(actions[0]);
        const context = await processor.newContext(uri, actions, bs);
        // 如果客户端支持AVIF并且配置启用了自动AVIF
        if (ctx.features && ctx.features[processor_1.Features.AutoAvif]) {
            context.features[processor_1.Features.AutoAvif] = true;
        }
        const { data, type } = await processor.process(context);
        return { data, type, headers: context.headers };
    }
    else {
        console.log(`Direct access to image: ${uri}`);
        // 如果没有处理操作，调用beforeGetFn（即bypass函数）
        if (beforeGetFn) {
            beforeGetFn();
        }
        const { buffer, type, headers } = await bs.get(uri);
        return { data: buffer, type: type, headers: headers };
    }
}
async function validatePostRequest(ctx) {
    // Fox edited in 2022/04/25: enhance the security of the post requests
    const authHeader = ctx.get('X-Client-Authorization');
    const secretHeader = await getHeaderFromSecretsManager();
    if (authHeader !== secretHeader) {
        throw new processor_1.InvalidArgument('Invalid post header.');
    }
    const body = ctx.request.body;
    if (!body) {
        throw new processor_1.InvalidArgument('Empty post body.');
    }
    const valid = body.params
        && body.sourceBucket
        && body.sourceObject
        && body.targetBucket
        && body.targetObject;
    if (!valid) {
        throw new processor_1.InvalidArgument('Invalid post body.');
    }
    return {
        params: body.params,
        sourceBucket: body.sourceBucket,
        sourceObject: body.sourceObject,
        targetBucket: body.targetBucket,
        targetObject: body.targetObject,
    };
}
function bypass() {
    // 检查是否允许直接访问
    if (config_1.default.allowDirectAccess === 'true') {
        // 如果允许直接访问，则不抛出异常，让请求继续处理
        console.log('Direct access allowed, processing request');
        return;
    }
    // 否则，告诉CloudFront直接访问S3对象
    console.log('Direct access not allowed, redirecting to S3');
    throw new HttpErrors[403]('Please visit s3 directly');
}
async function getSecretFromSecretsManager() {
    // Load the AWS SDK
    const secretName = config_1.default.secretName;
    return smclient.getSecretValue({ SecretId: secretName }).promise();
}
async function getHeaderFromSecretsManager() {
    const secret = await getSecretFromSecretsManager();
    const secretString = secret.SecretString;
    const keypair = JSON.parse(secretString);
    return keypair['X-Client-Authorization'];
}
async function setMaxGifLimit() {
    var _a;
    if (config_1.default.configJsonParameterName) {
        const data = await ssm.getParameter({ Name: config_1.default.configJsonParameterName }).promise();
        if (data.Parameter) {
            const configJson = JSON.parse((_a = data.Parameter.Value) !== null && _a !== void 0 ? _a : '{}');
            const maxGifSizeMB = configJson.max_gif_size_mb;
            if (is.number(maxGifSizeMB)) {
                (0, default_1.setMaxGifSizeMB)(maxGifSizeMB);
            }
            const maxGifPages = configJson.max_gif_pages;
            if (is.number(maxGifPages)) {
                (0, default_1.setMaxGifPages)(maxGifPages);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5Q0FBeUM7QUFDekMsaUVBQWlFO0FBQ2pFLDJDQUEyQztBQUMzQywwQ0FBMEM7QUFDMUMsMkJBQTJCLENBQUMsa0JBQWtCO0FBQzlDLDZDQUE2QztBQUM3QyxvQ0FBb0M7QUFDcEMscUNBQXFDO0FBQ3JDLHFDQUFxQztBQUNyQyx5Q0FBcUM7QUFDckMsK0JBQStCO0FBQy9CLHFDQUE4QjtBQUM5QixtQ0FBNEI7QUFDNUIsdUNBQXNIO0FBQ3RILDJCQUEyQjtBQUMzQiwyQ0FBc0U7QUFRdEUsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDO0FBRW5CLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLGdCQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUMvQyxNQUFNLFFBQVEsR0FBRyxJQUFJLGNBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxnQkFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7QUFFL0Qsc0RBQXNEO0FBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUEseUJBQWUsR0FBRSxDQUFDO0FBQ3ZDLE1BQU0sa0JBQWtCLEdBQUcsSUFBQSxxQkFBVyxHQUFFLENBQUM7QUFFekMsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUN0QixNQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO0FBQzVCLE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBc0I7SUFDakQsR0FBRyxFQUFFLGdCQUFNLENBQUMsZUFBZTtJQUMzQixPQUFPLEVBQUUsZ0JBQU0sQ0FBQyxpQkFBaUIsR0FBRyxFQUFFO0lBQ3RDLEdBQUcsRUFBRSxnQkFBTSxDQUFDLGFBQWEsR0FBRyxJQUFJO0lBQ2hDLGVBQWUsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1FBQ3pCLE9B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LEtBQUssbUNBQUksSUFBSSxDQUFDLENBQUM7WUFDNUQsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLGVBQWUsQ0FBQztZQUNoRCxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQzNCLElBQUEseUJBQWUsRUFBQyxZQUFZLENBQUMsQ0FBQzthQUMvQjtZQUNELE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUM7WUFDN0MsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dCQUMxQixJQUFBLHdCQUFjLEVBQUMsV0FBVyxDQUFDLENBQUM7YUFDN0I7U0FDRjtLQUNGO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFMzIGZyb20gJ2F3cy1zZGsvY2xpZW50cy9zMyc7XG5pbXBvcnQgKiBhcyBTZWNyZXRzTWFuYWdlciBmcm9tICdhd3Mtc2RrL2NsaWVudHMvc2VjcmV0c21hbmFnZXInO1xuaW1wb3J0ICogYXMgU1NNIGZyb20gJ2F3cy1zZGsvY2xpZW50cy9zc20nO1xuaW1wb3J0ICogYXMgSHR0cEVycm9ycyBmcm9tICdodHRwLWVycm9ycyc7XG5pbXBvcnQgKiBhcyBLb2EgZnJvbSAna29hJzsgLy8gaHR0cDovL2tvYWpzLmNuXG5pbXBvcnQgKiBhcyBib2R5UGFyc2VyIGZyb20gJ2tvYS1ib2R5cGFyc2VyJztcbmltcG9ydCAqIGFzIGtvYUNhc2ggZnJvbSAna29hLWNhc2gnO1xuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJ2tvYS1sb2dnZXInO1xuaW1wb3J0ICogYXMgUm91dGVyIGZyb20gJ2tvYS1yb3V0ZXInO1xuaW1wb3J0IHsgTFJVQ2FjaGUgfSBmcm9tICdscnUtY2FjaGUnO1xuaW1wb3J0ICogYXMgc2hhcnAgZnJvbSAnc2hhcnAnO1xuaW1wb3J0IGNvbmZpZyBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgZGVidWcgZnJvbSAnLi9kZWJ1Zyc7XG5pbXBvcnQgeyBidWZmZXJTdG9yZSwgZ2V0QnVmZmVyU3RvcmVzLCBnZXRQcm9jZXNzb3IsIHBhcnNlUmVxdWVzdCwgc2V0TWF4R2lmU2l6ZU1CLCBzZXRNYXhHaWZQYWdlcyB9IGZyb20gJy4vZGVmYXVsdCc7XG5pbXBvcnQgKiBhcyBpcyBmcm9tICcuL2lzJztcbmltcG9ydCB7IEZlYXR1cmVzLCBJSHR0cEhlYWRlcnMsIEludmFsaWRBcmd1bWVudCB9IGZyb20gJy4vcHJvY2Vzc29yJztcbmltcG9ydCB7IElCdWZmZXJTdG9yZSB9IGZyb20gJy4vc3RvcmUnO1xuXG4vLyDlrprkuYnkuIDkuKrmjqXlj6PmnaXmianlsZVLb2HkuIrkuIvmlodcbmludGVyZmFjZSBFeHRlbmRlZENvbnRleHQgZXh0ZW5kcyBLb2EuUGFyYW1ldGVyaXplZENvbnRleHQge1xuICBmZWF0dXJlcz86IHsgW2tleTogc3RyaW5nXTogYW55IH07XG59XG5cbmNvbnN0IE1CID0gMTA0ODU3NjtcblxuY29uc3Qgc3NtID0gbmV3IFNTTSh7IHJlZ2lvbjogY29uZmlnLnJlZ2lvbiB9KTtcbmNvbnN0IHNtY2xpZW50ID0gbmV3IFNlY3JldHNNYW5hZ2VyKHsgcmVnaW9uOiBjb25maWcucmVnaW9uIH0pO1xuXG4vLyBJbml0aWFsaXplIGJ1ZmZlciBzdG9yZXMgZm9yIGFsbCBjb25maWd1cmVkIGJ1Y2tldHNcbmNvbnN0IGJ1ZmZlclN0b3JlcyA9IGdldEJ1ZmZlclN0b3JlcygpO1xuY29uc3QgRGVmYXVsdEJ1ZmZlclN0b3JlID0gYnVmZmVyU3RvcmUoKTtcblxuY29uc3QgYXBwID0gbmV3IEtvYSgpO1xuY29uc3Qgcm91dGVyID0gbmV3IFJvdXRlcigpO1xuY29uc3QgbHJ1Q2FjaGUgPSBuZXcgTFJVQ2FjaGU8c3RyaW5nLCBDYWNoZU9iamVjdD4oe1xuICBtYXg6IGNvbmZpZy5DQUNIRV9NQVhfSVRFTVMsXG4gIG1heFNpemU6IGNvbmZpZy5DQUNIRV9NQVhfU0laRV9NQiAqIE1CLFxuICB0dGw6IGNvbmZpZy5DQUNIRV9UVExfU0VDICogMTAwMCxcbiAgc2l6ZUNhbGN1bGF0aW9uOiAodmFsdWUpID0+IHtcbiAgICByZXR1cm4gdmFsdWUuYm9keS5sZW5ndGg7XG4gIH0sXG59KTtcblxuc2hhcnAuY2FjaGUoeyBpdGVtczogMTAwMCwgZmlsZXM6IDIwMCwgbWVtb3J5OiAyMDAwIH0pO1xuXG5hcHAudXNlKGxvZ2dlcigpKTtcbmFwcC51c2UoZXJyb3JIYW5kbGVyKCkpO1xuYXBwLnVzZShib2R5UGFyc2VyKCkpO1xuYXBwLnVzZShrb2FDYXNoKHtcbiAgc2V0Q2FjaGVkSGVhZGVyOiB0cnVlLFxuICBoYXNoKGN0eCkge1xuICAgIHJldHVybiBjdHguaGVhZGVyc1sneC1idWNrZXQnXSArIGN0eC5yZXF1ZXN0LnVybDtcbiAgfSxcbiAgZ2V0OiAoa2V5KSA9PiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShscnVDYWNoZS5nZXQoa2V5KSk7XG4gIH0sXG4gIHNldDogKGtleSwgdmFsdWUpID0+IHtcbiAgICBscnVDYWNoZS5zZXQoa2V5LCB2YWx1ZSBhcyBDYWNoZU9iamVjdCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9LFxufSkpO1xuXG5yb3V0ZXIucG9zdCgnL2ltYWdlcycsIGFzeW5jIChjdHgpID0+IHtcbiAgY29uc29sZS5sb2coJ3Bvc3QgcmVxdWVzdCBib2R5PScsIGN0eC5yZXF1ZXN0LmJvZHkpO1xuXG4gIGNvbnN0IG9wdCA9IGF3YWl0IHZhbGlkYXRlUG9zdFJlcXVlc3QoY3R4KTtcbiAgY3R4LnBhdGggPSBvcHQuc291cmNlT2JqZWN0O1xuICBjdHgucXVlcnlbJ3gtb3NzLXByb2Nlc3MnXSA9IG9wdC5wYXJhbXM7XG4gIGN0eC5oZWFkZXJzWyd4LWJ1Y2tldCddID0gb3B0LnNvdXJjZUJ1Y2tldDtcblxuICBjb25zdCB7IGRhdGEsIHR5cGUgfSA9IGF3YWl0IG9zc3Byb2Nlc3MoY3R4KTtcbiAgaWYgKHR5cGUgIT09ICdhcHBsaWNhdGlvbi9qc29uJykge1xuICAgIC8vIFRPRE86IERvIHdlIG5lZWQgdG8gYWJzdHJhY3QgdGhpcyB3aXRoIElCdWZmZXJTdG9yZT9cbiAgICBjb25zdCBfczM6IFMzID0gbmV3IFMzKHsgcmVnaW9uOiBjb25maWcucmVnaW9uIH0pO1xuICAgIGF3YWl0IF9zMy5wdXRPYmplY3Qoe1xuICAgICAgQnVja2V0OiBvcHQudGFyZ2V0QnVja2V0LFxuICAgICAgS2V5OiBvcHQudGFyZ2V0T2JqZWN0LFxuICAgICAgQ29udGVudFR5cGU6IHR5cGUsXG4gICAgICBCb2R5OiBkYXRhLFxuICAgIH0pLnByb21pc2UoKTtcblxuICAgIGN0eC5ib2R5ID0gYHNhdmVkIHJlc3VsdCB0byBzMzovLyR7b3B0LnRhcmdldEJ1Y2tldH0vJHtvcHQudGFyZ2V0T2JqZWN0fWA7XG4gIH1cbn0pO1xuXG5yb3V0ZXIuZ2V0KFsnLycsICcvcGluZyddLCBhc3luYyAoY3R4KSA9PiB7XG4gIGN0eC5ib2R5ID0gJ29rJztcblxuICB0cnkge1xuICAgIGF3YWl0IHNldE1heEdpZkxpbWl0KCk7XG4gIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcihlcnIpO1xuICB9XG59KTtcblxucm91dGVyLmdldChbJy9kZWJ1ZycsICcvX2RlYnVnJ10sIGFzeW5jIChjdHgpID0+IHtcbiAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZGVidWcobHJ1Q2FjaGUpKSk7XG4gIGN0eC5zdGF0dXMgPSA0MDA7XG4gIGN0eC5ib2R5ID0gJ1BsZWFzZSBjaGVjayB5b3VyIHNlcnZlciBsb2dzIGZvciBtb3JlIGRldGFpbHMhJztcbn0pO1xuXG5yb3V0ZXIuZ2V0KCcvKC4qKScsIGFzeW5jIChjdHg6IEV4dGVuZGVkQ29udGV4dCkgPT4ge1xuICBpZiAoYXdhaXQgY3R4LmNhc2hlZCgpKSByZXR1cm47XG5cbiAgY29uc3QgcXVldWUgPSBzaGFycC5jb3VudGVycygpLnF1ZXVlO1xuICBpZiAocXVldWUgPiBjb25maWcuc2hhcnBRdWV1ZUxpbWl0KSB7XG4gICAgY3R4LmJvZHkgPSB7IG1lc3NhZ2U6ICdUb28gbWFueSByZXF1ZXN0cywgcGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nIH07XG4gICAgY3R4LnN0YXR1cyA9IDQyOTtcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIC8vIOajgOafpUFjY2VwdOWktOaYr+WQpuWMheWQq2ltYWdlL2F2aWZcbiAgY29uc3QgYWNjZXB0SGVhZGVyID0gY3R4LmdldCgnQWNjZXB0JykgfHwgJyc7XG4gIGNvbnN0IGFjY2VwdHNBdmlmID0gYWNjZXB0SGVhZGVyLmluY2x1ZGVzKCdpbWFnZS9hdmlmJyk7XG4gIFxuICAvLyDlpoLmnpzlrqLmiLfnq6/mlK/mjIFBVklG5bm25LiU6YWN572u5ZCv55So5LqG6Ieq5YqoQVZJRlxuICBpZiAoYWNjZXB0c0F2aWYgJiYgY29uZmlnLmF1dG9BdmlmKSB7XG4gICAgY3R4LmZlYXR1cmVzID0gY3R4LmZlYXR1cmVzIHx8IHt9O1xuICAgIGN0eC5mZWF0dXJlc1tGZWF0dXJlcy5BdXRvQXZpZl0gPSB0cnVlO1xuICB9XG4gIFxuICBjb25zdCB7IGRhdGEsIHR5cGUsIGhlYWRlcnMgfSA9IGF3YWl0IG9zc3Byb2Nlc3MoY3R4LCBieXBhc3MpO1xuICBjdHguYm9keSA9IGRhdGE7XG4gIGN0eC50eXBlID0gdHlwZTtcbiAgY3R4LnNldChoZWFkZXJzKTtcbn0pO1xuXG5hcHAudXNlKHJvdXRlci5yb3V0ZXMoKSk7XG5hcHAudXNlKHJvdXRlci5hbGxvd2VkTWV0aG9kcyk7XG5cbmFwcC5vbignZXJyb3InLCAoZXJyOiBFcnJvcikgPT4ge1xuICBjb25zdCBtc2cgPSBlcnIuc3RhY2sgfHwgZXJyLnRvU3RyaW5nKCk7XG4gIGNvbnNvbGUuZXJyb3IoYFxcbiR7bXNnLnJlcGxhY2UoL14vZ20sICcgICcpfVxcbmApO1xufSk7XG5cbmFwcC5saXN0ZW4oY29uZmlnLnBvcnQsICgpID0+IHtcbiAgY29uc29sZS5sb2coYFNlcnZlciBydW5uaW5nIG9uIHBvcnQgJHtjb25maWcucG9ydH1gKTtcbiAgY29uc29sZS5sb2coJ0NvbmZpZzonLCBKU09OLnN0cmluZ2lmeShjb25maWcpKTtcbn0pO1xuXG5mdW5jdGlvbiBlcnJvckhhbmRsZXIoKTogS29hLk1pZGRsZXdhcmU8S29hLkRlZmF1bHRTdGF0ZSwgS29hLkRlZmF1bHRDb250ZXh0LCBhbnk+IHtcbiAgcmV0dXJuIGFzeW5jIChjdHgsIG5leHQpID0+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgbmV4dCgpO1xuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XG4gICAgICAvLyBFTk9FTlQgc3VwcG9ydFxuICAgICAgaWYgKGVyci5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgICBlcnIuc3RhdHVzID0gNDA0O1xuICAgICAgICBlcnIubWVzc2FnZSA9ICdOb3RGb3VuZCc7XG4gICAgICB9XG4gICAgICBjdHguc3RhdHVzID0gZXJyLnN0YXR1c0NvZGUgfHwgZXJyLnN0YXR1cyB8fCA1MDA7XG4gICAgICBjdHguYm9keSA9IHtcbiAgICAgICAgc3RhdHVzOiBlcnIuc3RhdHVzLFxuICAgICAgICBuYW1lOiBlcnIubmFtZSxcbiAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICB9O1xuXG4gICAgICBjdHguYXBwLmVtaXQoJ2Vycm9yJywgZXJyLCBjdHgpO1xuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0QnVmZmVyU3RvcmUoY3R4OiBFeHRlbmRlZENvbnRleHQpOiBJQnVmZmVyU3RvcmUge1xuICBjb25zdCBidWNrZXQgPSBjdHguaGVhZGVyc1sneC1idWNrZXQnXTtcbiAgaWYgKGJ1Y2tldCAmJiB0eXBlb2YgYnVja2V0ID09PSAnc3RyaW5nJykge1xuICAgIC8vIENoZWNrIGlmIHdlIGhhdmUgYSBzdG9yZSBmb3IgdGhpcyBidWNrZXRcbiAgICBjb25zdCBzdG9yZSA9IGJ1ZmZlclN0b3Jlcy5nZXQoYnVja2V0KTtcbiAgICBpZiAoc3RvcmUpIHtcbiAgICAgIHJldHVybiBzdG9yZTtcbiAgICB9XG4gICAgXG4gICAgLy8gSWYgdGhlIGJ1Y2tldCBpcyBub3QgaW4gb3VyIHByZS1jb25maWd1cmVkIGxpc3QgYnV0IGlzIHNwZWNpZmllZCBpbiB0aGUgcmVxdWVzdCxcbiAgICAvLyBjcmVhdGUgYSBuZXcgc3RvcmUgZm9yIGl0ICh0aGlzIGFsbG93cyBkeW5hbWljIGJ1Y2tldCBhY2Nlc3MpXG4gICAgY29uc3QgbmV3U3RvcmUgPSBidWZmZXJTdG9yZShidWNrZXQpO1xuICAgIGJ1ZmZlclN0b3Jlcy5zZXQoYnVja2V0LCBuZXdTdG9yZSk7XG4gICAgcmV0dXJuIG5ld1N0b3JlO1xuICB9XG4gIHJldHVybiBEZWZhdWx0QnVmZmVyU3RvcmU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG9zc3Byb2Nlc3MoY3R4OiBFeHRlbmRlZENvbnRleHQsIGJlZm9yZUdldEZuPzogKCkgPT4gdm9pZCk6XG5Qcm9taXNlPHsgZGF0YTogYW55OyB0eXBlOiBzdHJpbmc7IGhlYWRlcnM6IElIdHRwSGVhZGVycyB9PiB7XG4gIGNvbnN0IHsgdXJpLCBhY3Rpb25zIH0gPSBwYXJzZVJlcXVlc3QoY3R4LnBhdGgsIGN0eC5xdWVyeSk7XG4gIFxuICAvLyDlj6rpgJrov4cgeC1idWNrZXQg5aS06YCJ5oup5a2Y5YKo5qG277yM5LiN5YaN6Kej5p6Q6Lev5b6EXG4gIGNvbnN0IGJzID0gZ2V0QnVmZmVyU3RvcmUoY3R4KTtcbiAgXG4gIC8vIOajgOafpeaYr+WQpuacieWkhOeQhuaTjeS9nFxuICBpZiAoYWN0aW9ucy5sZW5ndGggPiAxKSB7XG4gICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgaW1hZ2Ugd2l0aCAke2FjdGlvbnMubGVuZ3RoIC0gMX0gYWN0aW9uc2ApO1xuICAgIGNvbnN0IHByb2Nlc3NvciA9IGdldFByb2Nlc3NvcihhY3Rpb25zWzBdKTtcbiAgICBjb25zdCBjb250ZXh0ID0gYXdhaXQgcHJvY2Vzc29yLm5ld0NvbnRleHQodXJpLCBhY3Rpb25zLCBicyk7XG4gICAgXG4gICAgLy8g5aaC5p6c5a6i5oi356uv5pSv5oyBQVZJRuW5tuS4lOmFjee9ruWQr+eUqOS6huiHquWKqEFWSUZcbiAgICBpZiAoY3R4LmZlYXR1cmVzICYmIGN0eC5mZWF0dXJlc1tGZWF0dXJlcy5BdXRvQXZpZl0pIHtcbiAgICAgIGNvbnRleHQuZmVhdHVyZXNbRmVhdHVyZXMuQXV0b0F2aWZdID0gdHJ1ZTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgeyBkYXRhLCB0eXBlIH0gPSBhd2FpdCBwcm9jZXNzb3IucHJvY2Vzcyhjb250ZXh0KTtcbiAgICByZXR1cm4geyBkYXRhLCB0eXBlLCBoZWFkZXJzOiBjb250ZXh0LmhlYWRlcnMgfTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgRGlyZWN0IGFjY2VzcyB0byBpbWFnZTogJHt1cml9YCk7XG4gICAgLy8g5aaC5p6c5rKh5pyJ5aSE55CG5pON5L2c77yM6LCD55SoYmVmb3JlR2V0Rm7vvIjljbNieXBhc3Plh73mlbDvvIlcbiAgICBpZiAoYmVmb3JlR2V0Rm4pIHtcbiAgICAgIGJlZm9yZUdldEZuKCk7XG4gICAgfVxuICAgIGNvbnN0IHsgYnVmZmVyLCB0eXBlLCBoZWFkZXJzIH0gPSBhd2FpdCBicy5nZXQodXJpKTtcbiAgICByZXR1cm4geyBkYXRhOiBidWZmZXIsIHR5cGU6IHR5cGUsIGhlYWRlcnM6IGhlYWRlcnMgfTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZVBvc3RSZXF1ZXN0KGN0eDogS29hLlBhcmFtZXRlcml6ZWRDb250ZXh0KSB7XG4gIC8vIEZveCBlZGl0ZWQgaW4gMjAyMi8wNC8yNTogZW5oYW5jZSB0aGUgc2VjdXJpdHkgb2YgdGhlIHBvc3QgcmVxdWVzdHNcbiAgY29uc3QgYXV0aEhlYWRlciA9IGN0eC5nZXQoJ1gtQ2xpZW50LUF1dGhvcml6YXRpb24nKTtcbiAgY29uc3Qgc2VjcmV0SGVhZGVyID0gYXdhaXQgZ2V0SGVhZGVyRnJvbVNlY3JldHNNYW5hZ2VyKCk7XG5cbiAgaWYgKGF1dGhIZWFkZXIgIT09IHNlY3JldEhlYWRlcikge1xuICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ0ludmFsaWQgcG9zdCBoZWFkZXIuJyk7XG4gIH1cblxuICBjb25zdCBib2R5ID0gY3R4LnJlcXVlc3QuYm9keTtcbiAgaWYgKCFib2R5KSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudCgnRW1wdHkgcG9zdCBib2R5LicpO1xuICB9XG4gIGNvbnN0IHZhbGlkID0gYm9keS5wYXJhbXNcbiAgICAmJiBib2R5LnNvdXJjZUJ1Y2tldFxuICAgICYmIGJvZHkuc291cmNlT2JqZWN0XG4gICAgJiYgYm9keS50YXJnZXRCdWNrZXRcbiAgICAmJiBib2R5LnRhcmdldE9iamVjdDtcbiAgaWYgKCF2YWxpZCkge1xuICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoJ0ludmFsaWQgcG9zdCBib2R5LicpO1xuICB9XG4gIHJldHVybiB7XG4gICAgcGFyYW1zOiBib2R5LnBhcmFtcyxcbiAgICBzb3VyY2VCdWNrZXQ6IGJvZHkuc291cmNlQnVja2V0LFxuICAgIHNvdXJjZU9iamVjdDogYm9keS5zb3VyY2VPYmplY3QsXG4gICAgdGFyZ2V0QnVja2V0OiBib2R5LnRhcmdldEJ1Y2tldCxcbiAgICB0YXJnZXRPYmplY3Q6IGJvZHkudGFyZ2V0T2JqZWN0LFxuICB9O1xufVxuXG5mdW5jdGlvbiBieXBhc3MoKSB7XG4gIC8vIOajgOafpeaYr+WQpuWFgeiuuOebtOaOpeiuv+mXrlxuICBpZiAoY29uZmlnLmFsbG93RGlyZWN0QWNjZXNzID09PSAndHJ1ZScpIHtcbiAgICAvLyDlpoLmnpzlhYHorrjnm7TmjqXorr/pl67vvIzliJnkuI3mipvlh7rlvILluLjvvIzorqnor7fmsYLnu6fnu63lpITnkIZcbiAgICBjb25zb2xlLmxvZygnRGlyZWN0IGFjY2VzcyBhbGxvd2VkLCBwcm9jZXNzaW5nIHJlcXVlc3QnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgLy8g5ZCm5YiZ77yM5ZGK6K+JQ2xvdWRGcm9udOebtOaOpeiuv+mXrlMz5a+56LGhXG4gIGNvbnNvbGUubG9nKCdEaXJlY3QgYWNjZXNzIG5vdCBhbGxvd2VkLCByZWRpcmVjdGluZyB0byBTMycpO1xuICB0aHJvdyBuZXcgSHR0cEVycm9yc1s0MDNdKCdQbGVhc2UgdmlzaXQgczMgZGlyZWN0bHknKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2VjcmV0RnJvbVNlY3JldHNNYW5hZ2VyKCkge1xuICAvLyBMb2FkIHRoZSBBV1MgU0RLXG4gIGNvbnN0IHNlY3JldE5hbWUgPSBjb25maWcuc2VjcmV0TmFtZTtcbiAgcmV0dXJuIHNtY2xpZW50LmdldFNlY3JldFZhbHVlKHsgU2VjcmV0SWQ6IHNlY3JldE5hbWUgfSkucHJvbWlzZSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRIZWFkZXJGcm9tU2VjcmV0c01hbmFnZXIoKSB7XG4gIGNvbnN0IHNlY3JldCA9IGF3YWl0IGdldFNlY3JldEZyb21TZWNyZXRzTWFuYWdlcigpO1xuICBjb25zdCBzZWNyZXRTdHJpbmcgPSBzZWNyZXQuU2VjcmV0U3RyaW5nITtcbiAgY29uc3Qga2V5cGFpciA9IEpTT04ucGFyc2Uoc2VjcmV0U3RyaW5nKTtcbiAgcmV0dXJuIGtleXBhaXJbJ1gtQ2xpZW50LUF1dGhvcml6YXRpb24nXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0TWF4R2lmTGltaXQoKSB7XG4gIGlmIChjb25maWcuY29uZmlnSnNvblBhcmFtZXRlck5hbWUpIHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgc3NtLmdldFBhcmFtZXRlcih7IE5hbWU6IGNvbmZpZy5jb25maWdKc29uUGFyYW1ldGVyTmFtZSB9KS5wcm9taXNlKCk7XG4gICAgaWYgKGRhdGEuUGFyYW1ldGVyKSB7XG4gICAgICBjb25zdCBjb25maWdKc29uID0gSlNPTi5wYXJzZShkYXRhLlBhcmFtZXRlci5WYWx1ZSA/PyAne30nKTtcbiAgICAgIGNvbnN0IG1heEdpZlNpemVNQiA9IGNvbmZpZ0pzb24ubWF4X2dpZl9zaXplX21iO1xuICAgICAgaWYgKGlzLm51bWJlcihtYXhHaWZTaXplTUIpKSB7XG4gICAgICAgIHNldE1heEdpZlNpemVNQihtYXhHaWZTaXplTUIpO1xuICAgICAgfVxuICAgICAgY29uc3QgbWF4R2lmUGFnZXMgPSBjb25maWdKc29uLm1heF9naWZfcGFnZXM7XG4gICAgICBpZiAoaXMubnVtYmVyKG1heEdpZlBhZ2VzKSkge1xuICAgICAgICBzZXRNYXhHaWZQYWdlcyhtYXhHaWZQYWdlcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG59Il19