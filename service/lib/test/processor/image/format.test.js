"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const sharp = require("sharp");
const processor_1 = require("../../../src/processor");
const format_1 = require("../../../src/processor/image/format");
const utils_1 = require("./utils");
test('format action validate', () => {
    const action = new format_1.FormatAction();
    const param1 = action.validate('format,jpg'.split(','));
    expect(param1).toEqual({
        format: 'jpg',
    });
    expect(() => {
        action.validate('format'.split(','));
    }).toThrowError(/Format param error, e.g: format,jpg/);
    expect(() => {
        action.validate('format,jpg,png'.split(','));
    }).toThrowError(/Format param error, e.g: format,jpg/);
    expect(() => {
        action.validate('format,abc'.split(','));
    }).toThrowError(/Format must be one of/);
    expect(() => {
        action.validate('format,12'.split(','));
    }).toThrowError(/Format must be one of/);
});
test('format action', async () => {
    const ctx = await (0, utils_1.mkctx)('example.jpg');
    const action = new format_1.FormatAction();
    await action.process(ctx, 'format,png'.split(','));
    const { info } = await ctx.image.toBuffer({ resolveWithObject: true });
    expect(info.format).toBe(sharp.format.png.id);
});
test('format action', async () => {
    const ctx = await (0, utils_1.mkctx)('example.jpg');
    const action = new format_1.FormatAction();
    await action.process(ctx, 'format,webp'.split(','));
    const { info } = await ctx.image.toBuffer({ resolveWithObject: true });
    expect(info.format).toBe(sharp.format.webp.id);
});
test('format action', async () => {
    const ctx = await (0, utils_1.mkctx)('example.jpg');
    const action = new format_1.FormatAction();
    await action.process(ctx, 'format,jpg'.split(','));
    const { info } = await ctx.image.toBuffer({ resolveWithObject: true });
    expect(info.format).toBe(sharp.format.jpeg.id);
});
test('format,jpeg', async () => {
    const ctx = await (0, utils_1.mkctx)('example.jpg');
    const action = new format_1.FormatAction();
    await action.process(ctx, 'format,jpeg'.split(','));
    const { info } = await ctx.image.toBuffer({ resolveWithObject: true });
    expect(info.format).toBe(sharp.format.jpeg.id);
});
test('format,gif', async () => {
    const ctx = await (0, utils_1.mkctx)('example.gif');
    const action = new format_1.FormatAction();
    await action.process(ctx, 'format,gif'.split(','));
    const { info, data } = await ctx.image.toBuffer({ resolveWithObject: true });
    expect(info.format).toBe(sharp.format.gif.id);
    const metadata = await sharp(data, { animated: true }).metadata();
    expect(metadata.pages).toBe(3);
});
test(`format,png disable ${processor_1.Features.ReadAllAnimatedFrames}`, async () => {
    const ctx = await (0, utils_1.mkctx)('example.gif');
    const action = new format_1.FormatAction();
    action.beforeNewContext(ctx, 'format,png'.split(','));
    expect(ctx.features[processor_1.Features.ReadAllAnimatedFrames]).toBe(false);
    action.beforeNewContext(ctx, 'format,jpg'.split(','));
    expect(ctx.features[processor_1.Features.ReadAllAnimatedFrames]).toBe(false);
    action.beforeNewContext(ctx, 'format,jpeg'.split(','));
    expect(ctx.features[processor_1.Features.ReadAllAnimatedFrames]).toBe(false);
});
test(`format,png enable ${processor_1.Features.ReadAllAnimatedFrames}`, async () => {
    const ctx = await (0, utils_1.mkctx)('example.gif');
    const action = new format_1.FormatAction();
    action.beforeNewContext(ctx, 'format,gif'.split(','));
    expect(ctx.features[processor_1.Features.ReadAllAnimatedFrames]).toBe(true);
    action.beforeNewContext(ctx, 'format,webp'.split(','));
    expect(ctx.features[processor_1.Features.ReadAllAnimatedFrames]).toBe(true);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0LnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90ZXN0L3Byb2Nlc3Nvci9pbWFnZS9mb3JtYXQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUMvQixzREFBa0Q7QUFDbEQsZ0VBQW1FO0FBQ25FLG1DQUFnQztBQUVoQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLE1BQU0sTUFBTSxHQUFHLElBQUkscUJBQVksRUFBRSxDQUFDO0lBQ2xDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3hELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDckIsTUFBTSxFQUFFLEtBQUs7S0FDZCxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsR0FBRyxFQUFFO1FBQ1YsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDdkMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLHFDQUFxQyxDQUFDLENBQUM7SUFHdkQsTUFBTSxDQUFDLEdBQUcsRUFBRTtRQUNWLE1BQU0sQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDL0MsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLHFDQUFxQyxDQUFDLENBQUM7SUFFdkQsTUFBTSxDQUFDLEdBQUcsRUFBRTtRQUNWLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0lBR3pDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7UUFDVixNQUFNLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUMxQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUUzQyxDQUFDLENBQUMsQ0FBQztBQUdILElBQUksQ0FBQyxlQUFlLEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDL0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFBLGFBQUssRUFBQyxhQUFhLENBQUMsQ0FBQztJQUN2QyxNQUFNLE1BQU0sR0FBRyxJQUFJLHFCQUFZLEVBQUUsQ0FBQztJQUNsQyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNuRCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDdkUsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDaEQsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsZUFBZSxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQy9CLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSxhQUFLLEVBQUMsYUFBYSxDQUFDLENBQUM7SUFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxxQkFBWSxFQUFFLENBQUM7SUFDbEMsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDcEQsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxpQkFBaUIsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2pELENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLGVBQWUsRUFBRSxLQUFLLElBQUksRUFBRTtJQUMvQixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUEsYUFBSyxFQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3ZDLE1BQU0sTUFBTSxHQUFHLElBQUkscUJBQVksRUFBRSxDQUFDO0lBQ2xDLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ25ELE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUN2RSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNqRCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxhQUFhLEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDN0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFBLGFBQUssRUFBQyxhQUFhLENBQUMsQ0FBQztJQUN2QyxNQUFNLE1BQU0sR0FBRyxJQUFJLHFCQUFZLEVBQUUsQ0FBQztJQUNsQyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNwRCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDdkUsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDakQsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsWUFBWSxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQzVCLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSxhQUFLLEVBQUMsYUFBYSxDQUFDLENBQUM7SUFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxxQkFBWSxFQUFFLENBQUM7SUFDbEMsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDbkQsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUU3RSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUU5QyxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNsRSxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNqQyxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxzQkFBc0Isb0JBQVEsQ0FBQyxxQkFBcUIsRUFBRSxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQ3RFLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBQSxhQUFLLEVBQUMsYUFBYSxDQUFDLENBQUM7SUFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxxQkFBWSxFQUFFLENBQUM7SUFDbEMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDdEQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsb0JBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3RELE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLG9CQUFRLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN2RCxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxvQkFBUSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDbkUsQ0FBQyxDQUFDLENBQUM7QUFHSCxJQUFJLENBQUMscUJBQXFCLG9CQUFRLENBQUMscUJBQXFCLEVBQUUsRUFBRSxLQUFLLElBQUksRUFBRTtJQUNyRSxNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUEsYUFBSyxFQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3ZDLE1BQU0sTUFBTSxHQUFHLElBQUkscUJBQVksRUFBRSxDQUFDO0lBQ2xDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3RELE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLG9CQUFRLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN2RCxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxvQkFBUSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDbEUsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzaGFycCBmcm9tICdzaGFycCc7XG5pbXBvcnQgeyBGZWF0dXJlcyB9IGZyb20gJy4uLy4uLy4uL3NyYy9wcm9jZXNzb3InO1xuaW1wb3J0IHsgRm9ybWF0QWN0aW9uIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3Byb2Nlc3Nvci9pbWFnZS9mb3JtYXQnO1xuaW1wb3J0IHsgbWtjdHggfSBmcm9tICcuL3V0aWxzJztcblxudGVzdCgnZm9ybWF0IGFjdGlvbiB2YWxpZGF0ZScsICgpID0+IHtcbiAgY29uc3QgYWN0aW9uID0gbmV3IEZvcm1hdEFjdGlvbigpO1xuICBjb25zdCBwYXJhbTEgPSBhY3Rpb24udmFsaWRhdGUoJ2Zvcm1hdCxqcGcnLnNwbGl0KCcsJykpO1xuICBleHBlY3QocGFyYW0xKS50b0VxdWFsKHtcbiAgICBmb3JtYXQ6ICdqcGcnLFxuICB9KTtcblxuICBleHBlY3QoKCkgPT4ge1xuICAgIGFjdGlvbi52YWxpZGF0ZSgnZm9ybWF0Jy5zcGxpdCgnLCcpKTtcbiAgfSkudG9UaHJvd0Vycm9yKC9Gb3JtYXQgcGFyYW0gZXJyb3IsIGUuZzogZm9ybWF0LGpwZy8pO1xuXG5cbiAgZXhwZWN0KCgpID0+IHtcbiAgICBhY3Rpb24udmFsaWRhdGUoJ2Zvcm1hdCxqcGcscG5nJy5zcGxpdCgnLCcpKTtcbiAgfSkudG9UaHJvd0Vycm9yKC9Gb3JtYXQgcGFyYW0gZXJyb3IsIGUuZzogZm9ybWF0LGpwZy8pO1xuXG4gIGV4cGVjdCgoKSA9PiB7XG4gICAgYWN0aW9uLnZhbGlkYXRlKCdmb3JtYXQsYWJjJy5zcGxpdCgnLCcpKTtcbiAgfSkudG9UaHJvd0Vycm9yKC9Gb3JtYXQgbXVzdCBiZSBvbmUgb2YvKTtcblxuXG4gIGV4cGVjdCgoKSA9PiB7XG4gICAgYWN0aW9uLnZhbGlkYXRlKCdmb3JtYXQsMTInLnNwbGl0KCcsJykpO1xuICB9KS50b1Rocm93RXJyb3IoL0Zvcm1hdCBtdXN0IGJlIG9uZSBvZi8pO1xuXG59KTtcblxuXG50ZXN0KCdmb3JtYXQgYWN0aW9uJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBjdHggPSBhd2FpdCBta2N0eCgnZXhhbXBsZS5qcGcnKTtcbiAgY29uc3QgYWN0aW9uID0gbmV3IEZvcm1hdEFjdGlvbigpO1xuICBhd2FpdCBhY3Rpb24ucHJvY2VzcyhjdHgsICdmb3JtYXQscG5nJy5zcGxpdCgnLCcpKTtcbiAgY29uc3QgeyBpbmZvIH0gPSBhd2FpdCBjdHguaW1hZ2UudG9CdWZmZXIoeyByZXNvbHZlV2l0aE9iamVjdDogdHJ1ZSB9KTtcbiAgZXhwZWN0KGluZm8uZm9ybWF0KS50b0JlKHNoYXJwLmZvcm1hdC5wbmcuaWQpO1xufSk7XG5cbnRlc3QoJ2Zvcm1hdCBhY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGN0eCA9IGF3YWl0IG1rY3R4KCdleGFtcGxlLmpwZycpO1xuICBjb25zdCBhY3Rpb24gPSBuZXcgRm9ybWF0QWN0aW9uKCk7XG4gIGF3YWl0IGFjdGlvbi5wcm9jZXNzKGN0eCwgJ2Zvcm1hdCx3ZWJwJy5zcGxpdCgnLCcpKTtcbiAgY29uc3QgeyBpbmZvIH0gPSBhd2FpdCBjdHguaW1hZ2UudG9CdWZmZXIoeyByZXNvbHZlV2l0aE9iamVjdDogdHJ1ZSB9KTtcbiAgZXhwZWN0KGluZm8uZm9ybWF0KS50b0JlKHNoYXJwLmZvcm1hdC53ZWJwLmlkKTtcbn0pO1xuXG50ZXN0KCdmb3JtYXQgYWN0aW9uJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBjdHggPSBhd2FpdCBta2N0eCgnZXhhbXBsZS5qcGcnKTtcbiAgY29uc3QgYWN0aW9uID0gbmV3IEZvcm1hdEFjdGlvbigpO1xuICBhd2FpdCBhY3Rpb24ucHJvY2VzcyhjdHgsICdmb3JtYXQsanBnJy5zcGxpdCgnLCcpKTtcbiAgY29uc3QgeyBpbmZvIH0gPSBhd2FpdCBjdHguaW1hZ2UudG9CdWZmZXIoeyByZXNvbHZlV2l0aE9iamVjdDogdHJ1ZSB9KTtcbiAgZXhwZWN0KGluZm8uZm9ybWF0KS50b0JlKHNoYXJwLmZvcm1hdC5qcGVnLmlkKTtcbn0pO1xuXG50ZXN0KCdmb3JtYXQsanBlZycsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgY3R4ID0gYXdhaXQgbWtjdHgoJ2V4YW1wbGUuanBnJyk7XG4gIGNvbnN0IGFjdGlvbiA9IG5ldyBGb3JtYXRBY3Rpb24oKTtcbiAgYXdhaXQgYWN0aW9uLnByb2Nlc3MoY3R4LCAnZm9ybWF0LGpwZWcnLnNwbGl0KCcsJykpO1xuICBjb25zdCB7IGluZm8gfSA9IGF3YWl0IGN0eC5pbWFnZS50b0J1ZmZlcih7IHJlc29sdmVXaXRoT2JqZWN0OiB0cnVlIH0pO1xuICBleHBlY3QoaW5mby5mb3JtYXQpLnRvQmUoc2hhcnAuZm9ybWF0LmpwZWcuaWQpO1xufSk7XG5cbnRlc3QoJ2Zvcm1hdCxnaWYnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGN0eCA9IGF3YWl0IG1rY3R4KCdleGFtcGxlLmdpZicpO1xuICBjb25zdCBhY3Rpb24gPSBuZXcgRm9ybWF0QWN0aW9uKCk7XG4gIGF3YWl0IGFjdGlvbi5wcm9jZXNzKGN0eCwgJ2Zvcm1hdCxnaWYnLnNwbGl0KCcsJykpO1xuICBjb25zdCB7IGluZm8sIGRhdGEgfSA9IGF3YWl0IGN0eC5pbWFnZS50b0J1ZmZlcih7IHJlc29sdmVXaXRoT2JqZWN0OiB0cnVlIH0pO1xuXG4gIGV4cGVjdChpbmZvLmZvcm1hdCkudG9CZShzaGFycC5mb3JtYXQuZ2lmLmlkKTtcblxuICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHNoYXJwKGRhdGEsIHsgYW5pbWF0ZWQ6IHRydWUgfSkubWV0YWRhdGEoKTtcbiAgZXhwZWN0KG1ldGFkYXRhLnBhZ2VzKS50b0JlKDMpO1xufSk7XG5cbnRlc3QoYGZvcm1hdCxwbmcgZGlzYWJsZSAke0ZlYXR1cmVzLlJlYWRBbGxBbmltYXRlZEZyYW1lc31gLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGN0eCA9IGF3YWl0IG1rY3R4KCdleGFtcGxlLmdpZicpO1xuICBjb25zdCBhY3Rpb24gPSBuZXcgRm9ybWF0QWN0aW9uKCk7XG4gIGFjdGlvbi5iZWZvcmVOZXdDb250ZXh0KGN0eCwgJ2Zvcm1hdCxwbmcnLnNwbGl0KCcsJykpO1xuICBleHBlY3QoY3R4LmZlYXR1cmVzW0ZlYXR1cmVzLlJlYWRBbGxBbmltYXRlZEZyYW1lc10pLnRvQmUoZmFsc2UpO1xuICBhY3Rpb24uYmVmb3JlTmV3Q29udGV4dChjdHgsICdmb3JtYXQsanBnJy5zcGxpdCgnLCcpKTtcbiAgZXhwZWN0KGN0eC5mZWF0dXJlc1tGZWF0dXJlcy5SZWFkQWxsQW5pbWF0ZWRGcmFtZXNdKS50b0JlKGZhbHNlKTtcbiAgYWN0aW9uLmJlZm9yZU5ld0NvbnRleHQoY3R4LCAnZm9ybWF0LGpwZWcnLnNwbGl0KCcsJykpO1xuICBleHBlY3QoY3R4LmZlYXR1cmVzW0ZlYXR1cmVzLlJlYWRBbGxBbmltYXRlZEZyYW1lc10pLnRvQmUoZmFsc2UpO1xufSk7XG5cblxudGVzdChgZm9ybWF0LHBuZyBlbmFibGUgJHtGZWF0dXJlcy5SZWFkQWxsQW5pbWF0ZWRGcmFtZXN9YCwgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBjdHggPSBhd2FpdCBta2N0eCgnZXhhbXBsZS5naWYnKTtcbiAgY29uc3QgYWN0aW9uID0gbmV3IEZvcm1hdEFjdGlvbigpO1xuICBhY3Rpb24uYmVmb3JlTmV3Q29udGV4dChjdHgsICdmb3JtYXQsZ2lmJy5zcGxpdCgnLCcpKTtcbiAgZXhwZWN0KGN0eC5mZWF0dXJlc1tGZWF0dXJlcy5SZWFkQWxsQW5pbWF0ZWRGcmFtZXNdKS50b0JlKHRydWUpO1xuICBhY3Rpb24uYmVmb3JlTmV3Q29udGV4dChjdHgsICdmb3JtYXQsd2VicCcuc3BsaXQoJywnKSk7XG4gIGV4cGVjdChjdHguZmVhdHVyZXNbRmVhdHVyZXMuUmVhZEFsbEFuaW1hdGVkRnJhbWVzXSkudG9CZSh0cnVlKTtcbn0pOyJdfQ==